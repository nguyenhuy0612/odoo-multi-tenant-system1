{% extends "base.html" %}
{% block title %}Manage Tenant - {{ tenant.name }} - Khudroo{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb" style="background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); padding: 1rem 1.5rem; border-radius: 12px; border: 1px solid var(--border-primary); box-shadow: var(--shadow-sm);">
        <li class="breadcrumb-item">
          <a href="{{ url_for('dashboard') }}" style="color: var(--primary); text-decoration: none; font-weight: 500;">Dashboard</a>
        </li>
        <li class="breadcrumb-item active" style="color: var(--text-primary); font-weight: 600;">{{ tenant.name }}</li>
      </ol>
    </nav>
    <h2 style="color: var(--text-primary); margin-top: 1.5rem;"><i class="fas fa-cog me-2 text-primary"></i>Manage Tenant: {{ tenant.name }}</h2>
  </div>
</div>

<!-- Usage Statistics -->
<div class="row mb-4 g-4">
  <div class="col-lg-3 col-md-6">
    <div class="card text-center border-0 shadow-sm h-100" style="border-radius: 16px; transition: all 0.3s ease; min-height: 200px;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'">
      <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center">
        <button type="button" class="btn btn-outline-primary mb-3" data-bs-toggle="modal" data-bs-target="#appManagementModal" style="border-radius: 12px; padding: 0.75rem 1rem; width: 80px; height: 60px; display: flex; align-items: center; justify-content: center;">
          <i class="fab fa-uncharted fa-2x text-primary"></i>
        </button>
        <h3 class="card-title fw-bold mb-2" style="color: var(--text-primary); font-size: 2rem;">{{ modules }}</h3>
        <p class="card-text mb-0" style="color: var(--text-muted); font-size: 0.9rem; font-weight: 500;">Installed Applications</p>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="card text-center border-0 shadow-sm h-100" style="border-radius: 16px; transition: all 0.3s ease; min-height: 200px;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'">
      <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center">
        <div class="mb-3" style="width: 80px; height: 60px; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-hdd fa-2x text-info"></i>
        </div>
        <h3 class="card-title fw-bold mb-2" style="color: var(--text-primary); font-size: 2rem;">{{storage_usage}}</h3>
        <p class="card-text mb-0" style="color: var(--text-muted); font-size: 0.9rem; font-weight: 500;">Storage Used</p>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="card text-center border-0 shadow-sm h-100" style="border-radius: 16px; transition: all 0.3s ease; min-height: 200px;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'">
      <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center">
        <div class="mb-3" style="width: 80px; height: 60px; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-chart-line fa-2x text-success"></i>
        </div>
        <h3 class="card-title fw-bold mb-2" style="color: var(--text-primary); font-size: 2rem;">{{uptime}}</h3>
        <p class="card-text mb-0" style="color: var(--text-muted); font-size: 0.9rem; font-weight: 500;">Uptime</p>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="card text-center border-0 shadow-sm h-100" style="border-radius: 16px; transition: all 0.3s ease; min-height: 200px;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'">
      <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center">
        <div class="mb-3" style="width: 80px; height: 60px; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-users fa-2x text-warning"></i>
        </div>
        <h3 class="card-title fw-bold mb-2" style="color: var(--text-primary); font-size: 2rem;">{{odoo_user}}</h3>
        <p class="card-text mb-0" style="color: var(--text-muted); font-size: 0.9rem; font-weight: 500;">Total Users</p>
      </div>
    </div>
  </div>
</div>

<!-- Tenant Overview - Redesigned -->
<div class="row mb-4">
  <div class="col-md-8">
    <!-- Main Tenant Information Card -->
    <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px;">
      <div class="card-header border-0" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 16px 16px 0 0;">
        <div class="d-flex align-items-center justify-content-between w-100">
          <div class="d-flex align-items-center">
            <div class="p-3 rounded-circle me-3" style="background: rgba(255, 255, 255, 0.2);">
              <i class="fas fa-building text-white fa-lg"></i>
            </div>
            <div>
              <h4 class="mb-1 text-white fw-bold">{{ tenant.name }}</h4>
              <p class="mb-0" style="color: rgba(255, 255, 255, 0.8);">Tenant Configuration & Management</p>
            </div>
          </div>
          <div>
            <span class="badge bg-{{ 'success' if tenant.status == 'active' else 'warning' if tenant.status == 'inactive' else 'danger' }}" 
                  style="padding: 0.75rem 1.25rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">
              <i class="fas fa-circle me-2" style="font-size: 0.6rem;"></i>
              {{ tenant.status.title() }}
            </span>
          </div>
        </div>
      </div>
      
      <div class="card-body p-4">
        <div class="row g-4">
          <!-- Left Column - Basic Info -->
          <div class="col-md-6">
            <div class="mb-4">
              <h6 class="fw-bold mb-3" style="color: var(--text-primary); font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-info-circle text-primary me-2"></i>Basic Information
              </h6>
              
              <div class="mb-3">
                <div class="d-flex align-items-start">
                  <div class="me-3 mt-1">
                    <i class="fas fa-tag text-primary" style="font-size: 1.1rem;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-semibold mb-1" style="color: var(--text-secondary); font-size: 0.9rem;">Tenant Name</div>
                    <div class="fw-bold" style="color: var(--text-primary); font-size: 1.1rem;">{{ tenant.name }}</div>
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <div class="d-flex align-items-start">
                  <div class="me-3 mt-1">
                    <i class="fas fa-link text-info" style="font-size: 1.1rem;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-semibold mb-1" style="color: var(--text-secondary); font-size: 0.9rem;">Subdomain</div>
                    <div>
                      <a data-tenant-db="{{ tenant.db_name }}" target="_blank" 
                         class="text-decoration-none tenant-link fw-bold" 
                         style="color: var(--primary); font-size: 1rem;">
                        {{ tenant.db_name }}.<domain>
                        <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8rem;"></i>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <div class="d-flex align-items-start">
                  <div class="me-3 mt-1">
                    <i class="fas fa-crown text-warning" style="font-size: 1.1rem;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-semibold mb-1" style="color: var(--text-secondary); font-size: 0.9rem;">Subscription Plan</div>
                    <div>
                      <span class="badge bg-primary" style="padding: 0.6rem 1.2rem; border-radius: 15px; font-weight: 600; font-size: 0.85rem;">
                        {{ tenant.plan.title() }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Single Button to Open Combined Modal -->
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#appManagementModal">
                  Manage Applications
              </button>

            </div>
          </div>
          
          <!-- Right Column - Resources & Timeline -->
          <div class="col-md-6">
            <div class="mb-4">
              <h6 class="fw-bold mb-3" style="color: var(--text-primary); font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-chart-bar text-success me-2"></i>Resource Usage
              </h6>
              
              <div class="mb-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-users text-success me-3" style="font-size: 1.1rem;"></i>
                    <div>
                      <div class="fw-semibold" style="color: var(--text-secondary); font-size: 0.9rem;">Users</div>
                      <div class="fw-bold" style="color: var(--text-primary); font-size: 1.1rem;">{{ tenant.max_users }} max</div>
                    </div>
                  </div>
                  <div class="text-end">
                    <div class="progress mb-1" style="width: 80px; height: 8px;">
                      <div class="progress-bar bg-success" style="width: 65%;"></div>
                    </div>
                    <small class="fw-semibold" style="color: var(--text-secondary);">65% used</small>
                  </div>
                </div>
              </div>
              
              <div class="mb-4">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-hdd text-info me-3" style="font-size: 1.1rem;"></i>
                    <div>
                      <div class="fw-semibold" style="color: var(--text-secondary); font-size: 0.9rem;">Storage</div>
                      <div class="fw-bold" style="color: var(--text-primary); font-size: 1.1rem;">{{ tenant.storage_limit }} MB</div>
                    </div>
                  </div>
                  <div class="text-end">
                    <div class="progress mb-1" style="width: 80px; height: 8px;">
                      <div class="progress-bar bg-info" style="width: 40%;"></div>
                    </div>
                    <small class="fw-semibold" style="color: var(--text-secondary);">40% used</small>
                  </div>
                </div>
              </div>
            </div>
            
            <div>
              <h6 class="fw-bold mb-3" style="color: var(--text-primary); font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-history text-secondary me-2"></i>Timeline
              </h6>
              
              <div class="row">
                <div class="col-6">
                  <div class="text-center p-3 rounded-3" style="background: var(--bg-secondary);">
                    <i class="fas fa-calendar-plus text-primary mb-2 d-block" style="font-size: 1.5rem;"></i>
                    <div class="fw-semibold mb-1" style="color: var(--text-secondary); font-size: 0.85rem;">Created</div>
                    <div class="fw-bold" style="color: var(--text-primary); font-size: 0.95rem;">{{ tenant.created_at.strftime('%b %d, %Y') }}</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="text-center p-3 rounded-3" style="background: var(--bg-secondary);">
                    <i class="fas fa-sync-alt text-success mb-2 d-block" style="font-size: 1.5rem;"></i>
                    <div class="fw-semibold mb-1" style="color: var(--text-secondary); font-size: 0.85rem;">Updated</div>
                    <div class="fw-bold" style="color: var(--text-primary); font-size: 0.95rem;">{{ tenant.updated_at.strftime('%b %d, %Y') }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Access Credentials Card -->
    <div class="card shadow-lg border-0" style="border-radius: 16px;">
      <div class="card-header border-0" style="background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); border-radius: 16px 16px 0 0;">
        <div class="d-flex align-items-center">
          <div class="p-2 rounded-circle me-3" style="background: rgba(113, 75, 103, 0.2); color: var(--primary);">
            <i class="fas fa-key"></i>
          </div>
          <div>
            <h5 class="mb-0 fw-semibold" style="color: var(--text-primary);">Access Credentials</h5>
          </div>
        </div>
      </div>
      
      <div class="card-body p-3">
        <div class="row g-2">          
          <!-- Database Name -->
          <div class="col-md-4 col-sm-12">
            <div class="rounded-3 p-3" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <!-- Header with icon and label -->
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                  <div class="p-2 rounded-circle me-3" style="background: rgba(40, 167, 69, 0.2); color: var(--success);">
                    <i class="fas fa-database"></i>
                  </div>
                  <small class="fw-semibold" style="color: var(--text-secondary);">Database</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="copyText('{{tenant.database_name}}')" title="Copy database name" style="border-radius: 8px;">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
              
              <!-- Full width content field -->
              <div class="w-100">
                <div class="p-2" style="background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                  <code style="background: transparent; color: var(--text-primary); font-size: 0.9rem; word-break: break-all;">{{tenant.database_name}}</code>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Admin Username -->
          <div class="col-md-4 col-sm-12">
            <div class="rounded-3 p-3" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <!-- Header with icon and label -->
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                  <div class="p-2 rounded-circle me-3" style="background: rgba(113, 75, 103, 0.2); color: var(--primary);">
                    <i class="fas fa-user-shield"></i>
                  </div>
                  <small class="fw-semibold" style="color: var(--text-secondary);">Username</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="copyText('{{tenant.admin_username}}')" title="Copy username" style="border-radius: 8px;">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
              
              <!-- Full width content field -->
              <div class="w-100">
                <div class="p-2" style="background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                  <code style="background: transparent; color: var(--text-primary); font-size: 0.9rem; word-break: break-all;">{{tenant.admin_username}}</code>
                </div>
              </div>
            </div>
          </div>

          <!-- Admin Password -->
          <div class="col-md-4 col-sm-12">
            <div class="rounded-3 p-3" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <!-- Header with icon and label -->
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                  <div class="p-2 rounded-circle me-3" style="background: rgba(255, 193, 7, 0.2); color: var(--warning);">
                    <i class="fas fa-key"></i>
                  </div>
                  <small class="fw-semibold" style="color: var(--text-secondary);">Password</small>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-outline-primary" type="button" onclick="copyPassword()" title="Copy password" style="border-radius: 8px;">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
              
              <!-- Full width password field -->
              <div class="d-flex w-100">
                <input type="password" 
                      class="form-control border-0 p-2 flex-grow-1" 
                      style="background: rgba(255, 255, 255, 0.1); color: var(--text-primary); font-family: monospace; font-size: 0.9rem; border-radius: 8px 0px 0px 8px; word-break: break-all;" 
                      value="{{tenant.admin_password}}" 
                      readonly 
                      id="passwordField">
                      <button class="btn btn-sm btn-outline-secondary" type="button" onclick="togglePassword()" id="toggleBtn" style="border-radius: 0px 8px 8px 0px;">
                        <i class="fas fa-eye" id="eyeIcon"></i>
                      </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card-footer text-center py-3 border-0" style="background: linear-gradient(135deg, rgba(13, 202, 240, 0.1) 0%, rgba(13, 202, 240, 0.05) 100%); border-radius: 0 0 16px 16px; border-top: 1px solid var(--border-primary);">
        <small style="color: var(--info);">
          <i class="fas fa-shield-alt me-1"></i>
          Keep these credentials secure
        </small>
      </div>
    </div>
  </div>
  
  <!-- Right column content (unchanged) -->
  <div class="col-md-4">
    <!-- Quick Actions card remains the same -->
    <div class="card shadow-sm border-0" style="border-radius: 16px;">
        <div class="card-header text-white border-0" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 16px 16px 0 0;">
            <h5 class="mb-0 fw-semibold"><i class="fas fa-tools me-2"></i>Quick Actions</h5>
        </div>
        <div class="card-body p-4">
            <div class="d-grid gap-3">
                <!-- Open Tenant -->
                <a data-tenant-db="kdoo_{{ tenant.subdomain }}" target="_blank" class="btn btn-primary db-action-btn tenant-link" style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                    <i class="fas fa-external-link-alt me-2"></i>Open Tenant
                </a>
                
                <!-- Database Status Toggle -->
                <div class="db-toggle-form rounded-3 p-4" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="db-status-{{ 'active' if tenant.is_active else 'inactive' }} me-3">
                                <div class="p-3 rounded-circle" style="background: {{ 'rgba(40, 167, 69, 0.2)' if tenant.is_active else 'rgba(220, 53, 69, 0.2)' }}; color: {{ 'var(--success)' if tenant.is_active else 'var(--danger)' }};">
                                  <i class="fas {{ 'fa-running' if tenant.is_active else 'fa-ban' }} db-status-icon"></i>
                                </div>
                            </div>
                            <div>
                                <div class="db-status-text fw-semibold" style="color: var(--text-primary);">Database Status</div>
                                <small>
                                    <span class="badge bg-{{ 'success' if tenant.is_active else 'danger' }} db-status-badge" style="font-size: 0.75rem;">
                                        <i class="fas fa-circle me-1"></i>{{ 'Active' if tenant.is_active else 'Inactive' }}
                                    </span>
                                </small>
                            </div>
                        </div>
                        <form method="POST" action="{{ url_for('toggle_tenant', tenant_id=tenant.id) }}" class="mb-0">
                            <label class="db-toggle-switch">
                                <input type="checkbox" {{ 'checked' if tenant.is_active else '' }} onchange="this.form.submit()">
                                <span class="db-toggle-slider"></span>
                            </label>
                        </form>
                    </div>
                </div>
                
                <!-- Other action buttons remain the same -->
                <form method="POST" action="{{ url_for('restart_tenant', tenant_id=tenant.id) }}">
                    <button type="submit" class="btn btn-outline-warning w-100 db-action-btn" style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                        <i class="fas fa-redo me-2"></i>Restart Instance
                    </button>
                </form>
                
                <form method="POST" action="{{ url_for('backup_tenant', tenant_id=tenant.id) }}">
                    <button type="submit" class="btn btn-outline-info w-100 db-action-btn" style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                        <i class="fas fa-download me-2"></i>Create Backup
                    </button>
                </form>

                <button class="btn btn-outline-success w-100 db-action-btn" 
                        data-bs-toggle="modal" 
                        data-bs-target="#restoreModal" 
                        style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                    <i class="fas fa-upload me-2"></i>Restore Backup
                </button>
                                
                {% if current_user.is_admin %}
                <form method="POST" action="{{ url_for('delete_tenant', tenant_id=tenant.id) }}" onsubmit="return confirm('Are you sure you want to delete this tenant? This action cannot be undone.')">
                    <button type="submit" class="btn btn-outline-danger w-100 db-action-btn" style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                        <i class="fas fa-trash me-2"></i>Delete Tenant
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
  </div>
</div>


<!-- Modals -->
<!-- Restart Modal -->
<div class="modal fade" id="restartModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-redo me-2"></i>Restart Instance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to restart the tenant instance? This will cause a brief downtime.</p>
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> All active user sessions will be terminated.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning">Restart Instance</button>
      </div>
    </div>
  </div>
</div>

<!-- Backup Modal -->
<div class="modal fade" id="backupModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-download me-2"></i>Create Backup</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Create a backup of the tenant database and files.</p>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="includeFiles" checked>
          <label class="form-check-label" for="includeFiles">
            Include uploaded files
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info">Create Backup</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Tenant Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="tenantName" class="form-label">Tenant Name</label>
            <input type="text" class="form-control" id="tenantName" value="{{ tenant.name }}">
          </div>
          
          <div class="mb-3">
            <label for="planSelect" class="form-label">Plan</label>
            <select class="form-select" id="planSelect">
              <option value="basic" {{ 'selected' if tenant.plan == 'basic' }}>Basic</option>
              <option value="professional" {{ 'selected' if tenant.plan == 'professional' }}>Professional</option>
              <option value="enterprise" {{ 'selected' if tenant.plan == 'enterprise' }}>Enterprise</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="maxUsers" class="form-label">Max Users</label>
            <input type="number" class="form-control" id="maxUsers" value="{{ tenant.max_users }}">
          </div>
          
          <div class="mb-3">
            <label for="storageLimit" class="form-label">Storage Limit (MB)</label>
            <input type="number" class="form-control" id="storageLimit" value="{{ tenant.storage_limit }}">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
{% if current_user.is_admin %}
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-trash me-2"></i>Delete Tenant</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>This action cannot be undone!</strong>
        </div>
        <p>Are you sure you want to delete the tenant "<strong>{{ tenant.name }}</strong>"?</p>
        <p>This will permanently delete:</p>
        <ul>
          <li>All tenant data and databases</li>
          <li>All user accounts and settings</li>
          <li>All uploaded files and documents</li>
        </ul>
        <div class="mb-3">
          <label for="confirmDelete" class="form-label">Type <strong>{{ tenant.name }}</strong> to confirm:</label>
          <input type="text" class="form-control" id="confirmDelete" placeholder="Tenant name">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>Delete Tenant</button>
      </div>
    </div>
  </div>
</div>

<!-- Combined Apps Modal -->
<div class="modal fade" id="appManagementModal" tabindex="-1" aria-labelledby="appManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appManagementModalLabel">Application Management</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Left Side: Available Apps -->
                    <div class="col-md-6 border-end app-scroll-container">
                        <h6 class="text-center mb-3" style="color: var(--text-primary);">Available Applications</h6>
                        <div class="row" id="availableAppsList">
                            <!-- Available apps will be populated dynamically -->
                        </div>
                    </div>
                    <!-- Right Side: Installed Apps -->
                    <div class="col-md-6 app-scroll-container">
                        <h6 class="text-center mb-3" style="color: var(--text-primary);">Installed Applications</h6>
                        <div class="row" id="installedAppsList">
                            <!-- Installed apps will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Restore Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
            <!-- Enhanced Header with Gradient -->
            <div class="modal-header border-0" style="background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%); padding: 2rem;">
                <div class="d-flex align-items-center w-100">
                    <div class="p-3 rounded-circle me-3" style="background: rgba(255, 255, 255, 0.2);">
                        <i class="fas fa-upload text-white fa-lg"></i>
                    </div>
                    <div>
                        <h4 class="modal-title text-white fw-bold mb-1" id="restoreModalLabel">
                            Restore Database
                        </h4>
                        <p class="mb-0" style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;">
                            Upload and restore from a backup file
                        </p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <!-- Modal Body with Enhanced Design -->
            <div class="modal-body p-4">
                <form method="POST" action="{{ url_for('restore_tenant', tenant_id=tenant.id) }}" enctype="multipart/form-data" id="restoreForm">
                    
                    <!-- Warning Alert with Enhanced Design -->
                    <div class="alert alert-warning border-0 mb-4" style="border-radius: 12px; border-left: 4px solid var(--warning) !important; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);">
                        <div class="d-flex align-items-start">
                            <div class="p-2 rounded-circle me-3" style="background: rgba(255, 193, 7, 0.2);">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-2" style="color: var(--warning-dark);">Important Notice</h6>
                                <p class="mb-2" style="color: var(--warning-dark); font-size: 0.9rem;">
                                    This will <strong>completely replace</strong> your current database with the backup data.
                                </p>
                                <ul class="mb-0" style="color: var(--warning-dark); font-size: 0.85rem;">
                                    <li>All current data will be permanently lost</li>
                                    <li>Active user sessions will be terminated</li>
                                    <li>This action cannot be undone</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Section with Enhanced Design -->
                    <div class="mb-4">
                        <label for="backupFile" class="form-label fw-semibold mb-3">
                            <i class="fas fa-file-archive text-success me-2"></i>
                            Select Backup File
                        </label>
                        
                        <!-- Custom File Upload Area -->
                        <div class="file-upload-area" 
                             style="border: 2px dashed var(--border-primary); 
                                    border-radius: 12px; 
                                    padding: 2rem; 
                                    text-align: center; 
                                    background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
                                    transition: all 0.3s ease;
                                    cursor: pointer;"
                             onclick="document.getElementById('backupFile').click()"
                             onmouseover="this.style.borderColor='var(--success)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)'"
                             onmouseout="this.style.borderColor='var(--border-primary)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            
                            <div class="mb-3">
                                <div class="p-3 rounded-circle d-inline-flex" style="background: rgba(40, 167, 69, 0.1); color: var(--success);">
                                    <i class="fas fa-cloud-upload-alt fa-2x"></i>
                                </div>
                            </div>
                            
                            <h6 class="fw-semibold mb-2" style="color: var(--text-primary);">
                                Drop your backup file here or click to browse
                            </h6>
                            
                            <p class="mb-2" style="color: var(--text-muted); font-size: 0.9rem;">
                                Supports ZIP backup files only
                            </p>
                            
                            <div class="file-name-display" style="display: none; margin-top: 1rem;">
                                <div class="d-inline-flex align-items-center px-3 py-2 rounded-pill" 
                                     style="background: var(--success); color: white; font-size: 0.85rem;">
                                    <i class="fas fa-file-archive me-2"></i>
                                    <span class="file-name"></span>
                                    <i class="fas fa-check-circle ms-2"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden File Input -->
                        <input type="file" 
                               class="form-control d-none" 
                               id="backupFile" 
                               name="backup_file" 
                               accept=".zip" 
                               required>
                    </div>

                    <!-- Confirmation Checkbox with Enhanced Design -->
                    <div class="mb-4">
                        <div class="p-3 rounded-3" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary);">
                            <div class="form-check d-flex align-items-center">
                                <input class="form-check-input me-3" 
                                       type="checkbox" 
                                       id="confirmRestore" 
                                       required
                                       style="transform: scale(1.2);">
                                <label class="form-check-label fw-semibold" for="confirmRestore" style="color: var(--text-primary);">
                                    <i class="fas fa-shield-alt text-danger me-2"></i>
                                    I understand that this will permanently replace all current data
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Enhanced Footer with Action Buttons -->
            <div class="modal-footer border-0 p-4" style="background: var(--bg-tertiary);">
                <div class="d-flex gap-3 w-100">
                    <button type="button" 
                            class="btn btn-outline-secondary flex-fill" 
                            data-bs-dismiss="modal"
                            style="border-radius: 10px; padding: 0.75rem; font-weight: 500;">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    
                    <button type="button" 
                            class="btn btn-success flex-fill" 
                            id="confirmRestoreBtn"
                            disabled
                            onclick="submitRestoreForm()"
                            style="border-radius: 10px; padding: 0.75rem; font-weight: 500;">
                        <i class="fas fa-upload me-2"></i>
                        <span class="btn-text">Restore Database</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh status every 30 seconds
setInterval(function() {
    $.get('/api/tenant/{{ tenant.id }}/status')
        .done(function(data) {
            // Update status badge
            const statusBadge = $('.badge:contains("{{ tenant.status.title() }}")');
            statusBadge.removeClass('bg-success bg-warning bg-danger');
            statusBadge.addClass('bg-' + (data.status === 'active' ? 'success' : 'warning'));
            statusBadge.text(data.status.charAt(0).toUpperCase() + data.status.slice(1));
        });
}, 30000);

// Delete confirmation
document.getElementById('confirmDelete')?.addEventListener('input', function() {
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const tenantName = '{{ tenant.name }}';
    confirmBtn.disabled = this.value !== tenantName;
});

function copyText(text) {
    navigator.clipboard.writeText(text);
    
    // Show feedback
    const copyBtn = event.target.closest('button');
    const originalContent = copyBtn.innerHTML;
    copyBtn.innerHTML = '<i class="fas fa-check text-success"></i>';
    setTimeout(() => {
        copyBtn.innerHTML = originalContent;
    }, 1500);
}

function togglePassword() {
    const passwordField = document.getElementById('passwordField');
    const eyeIcon = document.getElementById('eyeIcon');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
    } else {
        passwordField.type = 'password';
        eyeIcon.classList.remove('fa-eye-slash');
        eyeIcon.classList.add('fa-eye');
    }
}

function copyPassword() {
    const passwordField = document.getElementById('passwordField');
    passwordField.select();
    passwordField.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(passwordField.value);
    
    // Show feedback
    const copyBtn = event.target.closest('button');
    const originalContent = copyBtn.innerHTML;
    copyBtn.innerHTML = '<i class="fas fa-check text-success"></i>';
    setTimeout(() => {
        copyBtn.innerHTML = originalContent;
    }, 2000);
}

document.addEventListener('DOMContentLoaded', () => {
    const tenantId = {{ tenant_id | tojson }};
    if (!tenantId || tenantId === "undefined" || tenantId === null) {
        console.error('Tenant ID is undefined. Ensure tenant.id is passed correctly in manage_tenant.html');
        AppUtils.showNotification('Error: Tenant ID not found', 'danger');
        return;
    }
    window.tenantId = tenantId;
    // Trigger log fetching and SocketIO initialization
    fetchLogs(tenantId);
    initSocketIO(tenantId);
});

document.addEventListener('DOMContentLoaded', function() {
    // Function to fetch and populate apps with animation
    function populateApps(endpoint, containerId) {
        fetch(endpoint, {
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch apps');
            }
            return response.json();
        })
        .then(data => {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear existing content
            
            if (data.apps && data.apps.length > 0) {
                data.apps.forEach((app, index) => {
                    console.log('Debug: App data:', app); // Debug log for app data
                    const appCard = document.createElement('div');
                    appCard.className = 'col-md-6 mb-3';
                    appCard.style.opacity = '0';
                    appCard.style.transform = 'scale(0.7)';
                    appCard.innerHTML = `
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body text-center">
                                <img src="${window.location.protocol}//{{tenant.database_name}}.${window.location.host}${app.icon || '/base/static/description/icon.png'}" 
                                     alt="${app.name}" 
                                     class="img-fluid mb-3 app-icon" 
                                     style="max-width: 64px; max-height: 64px;">
                                <h5 class="card-title">${app.name}</h5>
                                <p class="card-text small" style="color: var(--text-muted);">${app.summary || 'No description available'}</p>
                                <p class="card-text small">
                                    <strong>Category:</strong> ${app.category || 'Uncategorized'}<br>
                                    <strong>Version:</strong> ${app.version || 'N/A'}
                                </p>
                                ${app.can_install !== undefined ? `
                                    <button class="btn btn-sm ${app.can_install ? 'btn-primary' : 'btn-secondary disabled'} install-btn" 
                                            data-app="${app.technical_name}"
                                            ${!app.can_install ? 'disabled' : ''}>
                                        ${app.can_install ? 'Install' : 'Not Installable'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(appCard);

                    // Add pop animation with slight delay for each card
                    setTimeout(() => {
                        appCard.style.transition = 'all 0.3s ease-in-out';
                        appCard.style.opacity = '1';
                        appCard.style.transform = 'scale(1)';
                    }, index * 100);
                });
            } else {
                container.innerHTML = '<p style="color: var(--text-muted);" class="text-center">No applications available.</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching apps:', error);
            const container = document.getElementById(containerId);
            container.innerHTML = '<p class="text-danger text-center">Failed to load applications.</p>';
        });
    }

    // Populate both available and installed apps when modal is shown
    const appManagementModal = document.getElementById('appManagementModal');
    appManagementModal.addEventListener('show.bs.modal', function() {
        populateApps(`/api/tenant/${tenantId}/apps/available`, 'availableAppsList');
        populateApps(`/api/tenant/${tenantId}/apps/installed`, 'installedAppsList');
    });
});




document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('backupFile');
    const confirmCheckbox = document.getElementById('confirmRestore');
    const restoreBtn = document.getElementById('confirmRestoreBtn');
    const fileNameDisplay = document.querySelector('.file-name-display');
    const fileName = document.querySelector('.file-name');
    const uploadArea = document.querySelector('.file-upload-area');
    
    // File selection handler
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            fileName.textContent = file.name;
            fileNameDisplay.style.display = 'block';
            uploadArea.style.borderColor = 'var(--success)';
            uploadArea.style.background = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%)';
            checkFormValidity();
        }
    });
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--success)';
        this.style.background = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%)';
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--border-primary)';
        this.style.background = 'linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%)';
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].name.endsWith('.zip')) {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        }
    });
    
    // Checkbox handler
    confirmCheckbox.addEventListener('change', checkFormValidity);
    
    function checkFormValidity() {
        const hasFile = fileInput.files && fileInput.files[0];
        const isConfirmed = confirmCheckbox.checked;
        
        restoreBtn.disabled = !(hasFile && isConfirmed);
        
        if (hasFile && isConfirmed) {
            restoreBtn.classList.remove('btn-outline-success');
            restoreBtn.classList.add('btn-success');
        } else {
            restoreBtn.classList.remove('btn-success');
            restoreBtn.classList.add('btn-outline-success');
        }
    }
});

function submitRestoreForm() {
    const btn = document.getElementById('confirmRestoreBtn');
    const btnText = btn.querySelector('.btn-text');
    
    // Add loading state
    btn.disabled = true;
    btnText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Restoring...';
    
    // Submit form
    document.getElementById('restoreForm').submit();
}



</script>
{% endblock %}