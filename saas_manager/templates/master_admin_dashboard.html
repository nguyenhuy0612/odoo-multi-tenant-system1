<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Master Admin Dashboard - Functional</title>

    <!-- CSS Dependencies -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: #f8f9fa;
      }

      .admin-header {
        background: var(--primary-gradient);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-card h4 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        transition: box-shadow 0.3s ease;
      }

      .nav-tabs .nav-link.active {
        background: var(--primary-gradient);
        border-color: transparent;
        color: white;
        font-weight: 600;
      }

      .table thead th {
        background: #343a40;
        color: white;
        font-weight: 600;
        border: none;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .btn-primary {
        background: var(--primary-gradient);
        border: none;
      }

      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      .health-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }

      .health-excellent {
        background-color: var(--success-color);
      }
      .health-good {
        background-color: var(--warning-color);
      }
      .health-poor {
        background-color: var(--danger-color);
      }

      .metric-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
      }

      .metric-fill {
        height: 100%;
        transition: width 0.8s ease;
        border-radius: 4px;
      }

      #alerts-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }

      .action-buttons .btn {
        font-size: 0.8rem;
        padding: 4px 8px;
      }

      .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .stat-card h4 {
          font-size: 1.5rem;
        }
        .action-buttons {
          flex-direction: column;
        }
      }
    </style>
  </head>

  <body>
    <!-- Alerts Container -->
    <div id="alerts-container"></div>

    <!-- Loading Spinner -->
    <div
      id="loading-spinner"
      class="position-fixed top-50 start-50 translate-middle d-none"
      style="z-index: 9999"
    >
      <div
        class="spinner-border text-primary"
        style="width: 3rem; height: 3rem"
        role="status"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div class="container-fluid mt-3">
      <!-- Header Stats -->
      <div class="admin-header">
        <div class="row g-4">
          <div class="col-md-2">
            <div class="stat-card">
              <h4>
                <i class="fas fa-users"></i> <span id="total-users">0</span>
              </h4>
              <p>Total Users</p>
              <small><span id="active-users">0</span> active</small>
            </div>
          </div>
          <div class="col-md-2">
            <div class="stat-card">
              <h4>
                <i class="fas fa-building"></i>
                <span id="total-tenants">0</span>
              </h4>
              <p>Total Tenants</p>
              <small><span id="active-tenants">0</span> active</small>
            </div>
          </div>
          <div class="col-md-2">
            <div class="stat-card">
              <h4>
                <i class="fas fa-dollar-sign"></i> $<span id="total-revenue"
                  >0</span
                >
              </h4>
              <p>Monthly Revenue</p>
              <small>MRR</small>
            </div>
          </div>
          <div class="col-md-2">
            <div class="stat-card">
              <h4>
                <i class="fas fa-server"></i>
                <span id="running-workers">0</span>
              </h4>
              <p>Active Workers</p>
              <small
                ><span id="current-load">0</span>/<span id="total-capacity"
                  >0</span
                ></small
              >
            </div>
          </div>
          <div class="col-md-2">
            <div class="stat-card">
              <h4>
                <i class="fas fa-clock"></i> <span id="pending-tenants">0</span>
              </h4>
              <p>Pending</p>
              <small>Need attention</small>
            </div>
          </div>
          <div class="col-md-2">
            <div class="stat-card">
              <h4>
                <i class="fas fa-shield-alt"></i>
                <span id="admin-users">0</span>
              </h4>
              <p>Admins</p>
              <small>System access</small>
            </div>
          </div>
        </div>
      </div>

      <h1 class="mb-4">
        <i class="fas fa-crown text-warning"></i> Master Admin Control Center
      </h1>

      <!-- Navigation Tabs -->
      <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="overview-tab"
            data-bs-toggle="tab"
            href="#overview"
            role="tab"
          >
            <i class="fas fa-tachometer-alt"></i> Overview
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="users-tab"
            data-bs-toggle="tab"
            href="#users"
            role="tab"
          >
            <i class="fas fa-users"></i> Users (<span id="users-count">0</span>)
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="tenants-tab"
            data-bs-toggle="tab"
            href="#tenants"
            role="tab"
          >
            <i class="fas fa-building"></i> Tenants (<span id="tenants-count"
              >0</span
            >)
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="plans-tab"
            data-bs-toggle="tab"
            href="#plans"
            role="tab"
          >
            <i class="fas fa-tags"></i> Plans
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="analytics-tab"
            data-bs-toggle="tab"
            href="#analytics"
            role="tab"
          >
            <i class="fas fa-chart-bar"></i> Analytics
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="operations-tab"
            data-bs-toggle="tab"
            href="#operations"
            role="tab"
          >
            <i class="fas fa-cogs"></i> Operations
          </a>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="adminTabContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
          <div class="row">
            <!-- System Metrics -->
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-header">
                  <h5><i class="fas fa-server"></i> System Metrics</h5>
                  <button
                    class="btn btn-sm btn-outline-primary float-end"
                    onclick="Dashboard.refreshSystemMetrics()"
                  >
                    <i class="fas fa-sync"></i>
                  </button>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <div class="d-flex justify-content-between">
                      <span
                        ><i class="fas fa-microchip me-2"></i>CPU Usage</span
                      >
                      <span class="fw-bold" id="cpu-usage">0%</span>
                    </div>
                    <div class="metric-bar">
                      <div
                        class="metric-fill bg-primary"
                        id="cpu-bar"
                        style="width: 0%"
                      ></div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="d-flex justify-content-between">
                      <span
                        ><i class="fas fa-memory me-2"></i>Memory Usage</span
                      >
                      <span class="fw-bold" id="memory-usage">0%</span>
                    </div>
                    <div class="metric-bar">
                      <div
                        class="metric-fill bg-info"
                        id="memory-bar"
                        style="width: 0%"
                      ></div>
                    </div>
                  </div>
                  <div>
                    <div class="d-flex justify-content-between">
                      <span><i class="fas fa-hdd me-2"></i>Disk Usage</span>
                      <span class="fw-bold" id="disk-usage">0%</span>
                    </div>
                    <div class="metric-bar">
                      <div
                        class="metric-fill bg-warning"
                        id="disk-bar"
                        style="width: 0%"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-md-8">
              <div class="card h-100">
                <div class="card-header">
                  <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <button
                        class="btn btn-primary w-100"
                        onclick="Dashboard.performHealthCheck()"
                      >
                        <i class="fas fa-heartbeat"></i> System Health Check
                      </button>
                    </div>
                    <div class="col-md-6">
                      <button
                        class="btn btn-warning w-100"
                        onclick="Dashboard.performDatabaseBackup()"
                      >
                        <i class="fas fa-download"></i> Database Backup
                      </button>
                    </div>
                    <div class="col-md-6">
                      <button
                        class="btn btn-info w-100"
                        onclick="Dashboard.refreshAll()"
                      >
                        <i class="fas fa-sync"></i> Refresh All Data
                      </button>
                    </div>
                    <div class="col-md-6">
                      <button
                        class="btn btn-success w-100"
                        onclick="Dashboard.exportFullSystem()"
                      >
                        <i class="fas fa-download"></i> Export System Data
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between">
                  <h5><i class="fas fa-clock"></i> Recent Activity</h5>
                  <button
                    class="btn btn-sm btn-outline-primary"
                    onclick="Dashboard.loadAuditLogs()"
                  >
                    <i class="fas fa-sync"></i> Refresh
                  </button>
                </div>
                <div class="card-body">
                  <div
                    id="recent-activity"
                    style="max-height: 300px; overflow-y: auto"
                  >
                    <!-- Activity will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Tab -->
        <div class="tab-pane fade" id="users" role="tabpanel">
          <!-- User Filters -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <input
                    type="text"
                    class="form-control"
                    id="userSearch"
                    placeholder="Search users..."
                    onkeyup="Dashboard.filterUsers()"
                  />
                </div>
                <div class="col-md-2">
                  <select
                    class="form-select"
                    id="userStatusFilter"
                    onchange="Dashboard.filterUsers()"
                  >
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <select
                    class="form-select"
                    id="userAdminFilter"
                    onchange="Dashboard.filterUsers()"
                  >
                    <option value="">All Users</option>
                    <option value="admin">Admins Only</option>
                    <option value="user">Regular Users</option>
                  </select>
                </div>
                <div class="col-md-5">
                  <div class="d-flex gap-2">
                    <button
                      class="btn btn-success"
                      onclick="Dashboard.exportUsers()"
                    >
                      <i class="fas fa-download"></i> Export
                    </button>
                    <button
                      class="btn btn-primary"
                      onclick="Dashboard.bulkUserActions()"
                    >
                      <i class="fas fa-tasks"></i> Bulk Actions
                    </button>
                    <button
                      class="btn btn-info"
                      onclick="Dashboard.loadUsers()"
                    >
                      <i class="fas fa-sync"></i> Refresh
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Users Table -->
          <div class="card">
            <div class="table-responsive" style="max-height: 600px">
              <table class="table table-hover mb-0" id="usersTable">
                <thead>
                  <tr>
                    <th width="40">
                      <input
                        type="checkbox"
                        id="selectAllUsers"
                        onchange="Dashboard.toggleAllUsers()"
                      />
                    </th>
                    <th>User</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Tenants</th>
                    <th>Registration</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <!-- Users will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Tenants Tab -->
        <div class="tab-pane fade" id="tenants" role="tabpanel">
          <!-- Tenant Filters -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <input
                    type="text"
                    class="form-control"
                    id="tenantSearch"
                    placeholder="Search tenants..."
                    onkeyup="Dashboard.filterTenants()"
                  />
                </div>
                <div class="col-md-2">
                  <select
                    class="form-select"
                    id="tenantStatusFilter"
                    onchange="Dashboard.filterTenants()"
                  >
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="pending">Pending</option>
                    <option value="suspended">Suspended</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <select
                    class="form-select"
                    id="tenantPlanFilter"
                    onchange="Dashboard.filterTenants()"
                  >
                    <option value="">All Plans</option>
                  </select>
                </div>
                <div class="col-md-5">
                  <div class="d-flex gap-2">
                    <button
                      class="btn btn-success"
                      onclick="Dashboard.exportTenants()"
                    >
                      <i class="fas fa-download"></i> Export
                    </button>
                    <button
                      class="btn btn-primary"
                      onclick="Dashboard.bulkTenantActions()"
                    >
                      <i class="fas fa-tasks"></i> Bulk Actions
                    </button>
                    <button
                      class="btn btn-info"
                      onclick="Dashboard.loadTenants()"
                    >
                      <i class="fas fa-sync"></i> Refresh
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tenants Table -->
          <div class="card">
            <div class="table-responsive" style="max-height: 600px">
              <table class="table table-hover mb-0" id="tenantsTable">
                <thead>
                  <tr>
                    <th width="40">
                      <input
                        type="checkbox"
                        id="selectAllTenants"
                        onchange="Dashboard.toggleAllTenants()"
                      />
                    </th>
                    <th>Tenant</th>
                    <th>Status</th>
                    <th>Plan</th>
                    <th>Health</th>
                    <th>Usage</th>
                    <th>Revenue</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tenantsTableBody">
                  <!-- Tenants will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Plans Tab -->
        <div class="tab-pane fade" id="plans" role="tabpanel">
          <div class="row mb-3">
            <div class="col-12">
              <button
                class="btn btn-primary"
                onclick="Dashboard.showCreatePlanModal()"
              >
                <i class="fas fa-plus"></i> Create New Plan
              </button>
            </div>
          </div>

          <div class="card">
            <div class="table-responsive">
              <table class="table table-hover mb-0" id="plansTable">
                <thead>
                  <tr>
                    <th>Plan Name</th>
                    <th>Price</th>
                    <th>Max Users</th>
                    <th>Storage Limit</th>
                    <th>Features</th>
                    <th>Tenant Count</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="plansTableBody">
                  <!-- Plans will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-pane fade" id="analytics" role="tabpanel">
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-line"></i> User Growth</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="userGrowthChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-pie"></i> Plan Distribution</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="planDistributionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-bar"></i> Revenue Analytics</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-area"></i> Storage Usage</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="storageChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Operations Tab -->
        <div class="tab-pane fade" id="operations" role="tabpanel">
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-database"></i> Database Operations</h5>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <button
                      class="btn btn-primary"
                      onclick="Dashboard.performDatabaseBackup()"
                    >
                      <i class="fas fa-download"></i> Full System Backup
                    </button>
                    <button
                      class="btn btn-warning"
                      onclick="Dashboard.optimizeDatabase()"
                    >
                      <i class="fas fa-wrench"></i> Optimize Database
                    </button>
                    <button
                      class="btn btn-info"
                      onclick="Dashboard.cleanDatabase()"
                    >
                      <i class="fas fa-broom"></i> Clean Database
                    </button>
                    <button
                      class="btn btn-success"
                      onclick="Dashboard.runMigrations()"
                    >
                      <i class="fas fa-sync"></i> Run Migrations
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-cogs"></i> System Operations</h5>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <button
                      class="btn btn-primary"
                      onclick="Dashboard.clearCache()"
                    >
                      <i class="fas fa-trash"></i> Clear Cache
                    </button>
                    <button
                      class="btn btn-warning"
                      onclick="Dashboard.restartServices()"
                    >
                      <i class="fas fa-redo"></i> Restart Services
                    </button>
                    <button
                      class="btn btn-info"
                      onclick="Dashboard.updateSystem()"
                    >
                      <i class="fas fa-upload"></i> Update System
                    </button>
                    <button
                      class="btn btn-success"
                      onclick="Dashboard.performHealthCheck()"
                    >
                      <i class="fas fa-heartbeat"></i> Health Check
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Audit Logs -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between">
                  <h5><i class="fas fa-list"></i> Audit Logs</h5>
                  <button
                    class="btn btn-sm btn-outline-primary"
                    onclick="Dashboard.loadAuditLogs()"
                  >
                    <i class="fas fa-sync"></i> Refresh
                  </button>
                </div>
                <div class="card-body">
                  <div
                    id="audit-logs-container"
                    style="max-height: 400px; overflow-y: auto"
                  >
                    <!-- Audit logs will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <!-- Create Plan Modal -->
    <div class="modal fade" id="createPlanModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create New Plan</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createPlanForm">
              <div class="mb-3">
                <label class="form-label">Plan Name</label>
                <input type="text" class="form-control" name="name" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Price ($)</label>
                <input
                  type="number"
                  class="form-control"
                  name="price"
                  step="0.01"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Max Users</label>
                <input
                  type="number"
                  class="form-control"
                  name="max_users"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Storage Limit (MB)</label>
                <input
                  type="number"
                  class="form-control"
                  name="storage_limit"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Features (comma-separated)</label>
                <textarea
                  class="form-control"
                  name="features"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Modules (comma-separated)</label>
                <textarea
                  class="form-control"
                  name="modules"
                  rows="2"
                ></textarea>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="is_active"
                  checked
                />
                <label class="form-check-label">Active</label>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="Dashboard.createPlan()"
            >
              Create Plan
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script>
      // Dashboard Controller - Real Data Integration
      const Dashboard = {
        data: {
          users: [],
          tenants: [],
          plans: [],
          stats: {},
          analytics: {},
        },
        charts: {},
        refreshInterval: null,

        // Initialize dashboard
        async init() {
          try {
            this.showLoading();
            await this.loadAllData();
            this.initCharts();
            this.setupEventListeners();
            this.startAutoRefresh();
            this.showAlert("success", "Dashboard loaded successfully!");
          } catch (error) {
            console.error("Dashboard initialization failed:", error);
            this.showAlert(
              "danger",
              "Failed to load dashboard: " + error.message
            );
          } finally {
            this.hideLoading();
          }
        },

        // Load all data from APIs
        async loadAllData() {
          try {
            // Load stats first
            await this.loadStats();

            // Load other data in parallel
            await Promise.all([
              this.loadUsers(),
              this.loadTenants(),
              this.loadPlans(),
              this.loadAnalytics(),
            ]);
          } catch (error) {
            throw new Error("Failed to load data: " + error.message);
          }
        },

        // Load statistics
        async loadStats() {
          try {
            const response = await fetch("/master-admin/api/admin/stats");
            const result = await response.json();

            if (!result.success) {
              throw new Error(result.message || "Failed to load stats");
            }

            this.data.stats = result.stats;
            this.updateHeaderStats(result.stats);
            this.updateSystemMetrics(result.stats.system);
          } catch (error) {
            console.error("Failed to load stats:", error);
            throw error;
          }
        },

        // Update header statistics
        updateHeaderStats(stats) {
          document.getElementById("total-users").textContent =
            stats.users?.total || 0;
          document.getElementById("active-users").textContent =
            stats.users?.active || 0;
          document.getElementById("total-tenants").textContent =
            stats.tenants?.total || 0;
          document.getElementById("active-tenants").textContent =
            stats.tenants?.active || 0;
          document.getElementById("total-revenue").textContent =
            stats.revenue?.monthly_total || 0;
          document.getElementById("running-workers").textContent =
            stats.worker_stats?.running_workers || 0;
          document.getElementById("current-load").textContent =
            stats.worker_stats?.current_load || 0;
          document.getElementById("total-capacity").textContent =
            stats.worker_stats?.total_capacity || 0;
          document.getElementById("pending-tenants").textContent =
            stats.tenants?.pending || 0;
          document.getElementById("admin-users").textContent =
            stats.users?.admin_users || 0;

          // Update tab counts
          document.getElementById("users-count").textContent =
            stats.users?.total || 0;
          document.getElementById("tenants-count").textContent =
            stats.tenants?.total || 0;
        },

        // Update system metrics
        updateSystemMetrics(system) {
          if (!system) return;

          const cpuPercent = Math.round(system.cpu_percent || 0);
          const memoryPercent = Math.round(system.memory?.percent || 0);
          const diskPercent = Math.round(system.disk?.percent || 0);

          document.getElementById("cpu-usage").textContent = cpuPercent + "%";
          document.getElementById("memory-usage").textContent =
            memoryPercent + "%";
          document.getElementById("disk-usage").textContent = diskPercent + "%";

          document.getElementById("cpu-bar").style.width = cpuPercent + "%";
          document.getElementById("memory-bar").style.width =
            memoryPercent + "%";
          document.getElementById("disk-bar").style.width = diskPercent + "%";
        },

        // Load users
        async loadUsers() {
          try {
            const response = await fetch("/master-admin/api/admin/users/list");
            const result = await response.json();

            if (!result.success) {
              throw new Error(result.message || "Failed to load users");
            }

            this.data.users = result.users;
            this.renderUsers(result.users);
          } catch (error) {
            console.error("Failed to load users:", error);
            this.showAlert("danger", "Failed to load users");
          }
        },

        // Render users table
        renderUsers(users) {
          const tbody = document.getElementById("usersTableBody");
          tbody.innerHTML = "";

          users.forEach((user) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>
                            <input type="checkbox" class="user-checkbox" value="${
                              user.id
                            }">
                        </td>
                        <td>
                            <div>
                                <strong>${user.username}</strong>
                                ${
                                  user.is_admin
                                    ? '<span class="badge bg-primary ms-2">ADMIN</span>'
                                    : ""
                                }
                            </div>
                            <small class="text-muted">${user.email}</small>
                        </td>
                        <td>
                            <span class="badge bg-${
                              user.is_active ? "success" : "danger"
                            }">
                                ${user.is_active ? "Active" : "Inactive"}
                            </span>
                        </td>
                        <td><small>${user.last_login}</small></td>
                        <td><span class="badge bg-info">${
                          user.tenant_count
                        }</span></td>
                        <td><small>${user.created_at}</small></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-${
                                  user.is_active ? "warning" : "success"
                                }" 
                                        onclick="Dashboard.toggleUserStatus(${
                                          user.id
                                        })" 
                                        title="${
                                          user.is_active
                                            ? "Deactivate"
                                            : "Activate"
                                        }">
                                    <i class="fas fa-${
                                      user.is_active ? "pause" : "play"
                                    }"></i>
                                </button>
                                <button class="btn btn-sm btn-info" 
                                        onclick="Dashboard.viewUserDetails(${
                                          user.id
                                        })" 
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" 
                                        onclick="Dashboard.resetUserPassword(${
                                          user.id
                                        })" 
                                        title="Reset Password">
                                    <i class="fas fa-key"></i>
                                </button>
                            </div>
                        </td>
                    `;
            tbody.appendChild(row);
          });
        },

        // Load tenants
        async loadTenants() {
          try {
            const response = await fetch(
              "/master-admin/api/admin/tenants/list"
            );
            const result = await response.json();

            if (!result.success) {
              throw new Error(result.message || "Failed to load tenants");
            }

            this.data.tenants = result.tenants;
            this.renderTenants(result.tenants);
            this.updatePlanFilter();
          } catch (error) {
            console.error("Failed to load tenants:", error);
            this.showAlert("danger", "Failed to load tenants");
          }
        },

        // Render tenants table
        renderTenants(tenants) {
          const tbody = document.getElementById("tenantsTableBody");
          tbody.innerHTML = "";

          tenants.forEach((tenant) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>
                            <input type="checkbox" class="tenant-checkbox" value="${
                              tenant.id
                            }">
                        </td>
                        <td>
                            <div>
                                <strong>${tenant.name}</strong>
                                ${
                                  tenant.status === "pending"
                                    ? '<span class="badge bg-warning ms-2">PENDING</span>'
                                    : ""
                                }
                            </div>
                            <small class="text-muted">${
                              tenant.subdomain
                            }</small>
                        </td>
                        <td>
                            <span class="badge bg-${this.getStatusColor(
                              tenant.status
                            )}">
                                ${tenant.status.toUpperCase()}
                            </span>
                        </td>
                        <td><span class="badge bg-primary">${tenant.plan.toUpperCase()}</span></td>
                        <td>
                            <span class="health-indicator health-${
                              tenant.health
                            }"></span>
                            ${tenant.health}
                        </td>
                        <td>
                            <div>${tenant.storage_usage}</div>
                            <div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar" style="width: ${
                                  tenant.storage_percentage
                                }%"></div>
                            </div>
                            <small class="text-muted">${
                              tenant.user_count
                            } users</small>
                        </td>
                        <td><strong>${tenant.monthly_revenue}</strong></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-${
                                  tenant.status === "active"
                                    ? "warning"
                                    : "success"
                                }" 
                                        onclick="Dashboard.toggleTenantStatus(${
                                          tenant.id
                                        })"
                                        title="${
                                          tenant.status === "active"
                                            ? "Deactivate"
                                            : "Activate"
                                        }">
                                    <i class="fas fa-${
                                      tenant.status === "active"
                                        ? "pause"
                                        : "play"
                                    }"></i>
                                </button>
                                <button class="btn btn-sm btn-info" 
                                        onclick="Dashboard.viewTenantDetails(${
                                          tenant.id
                                        })"
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" 
                                        onclick="Dashboard.backupTenant(${
                                          tenant.id
                                        })"
                                        title="Backup">
                                    <i class="fas fa-download"></i>
                                </button>
                                ${
                                  tenant.status === "pending"
                                    ? `
                                    <button class="btn btn-sm btn-success" 
                                            onclick="Dashboard.approveTenant(${tenant.id})"
                                            title="Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                `
                                    : ""
                                }
                            </div>
                        </td>
                    `;
            tbody.appendChild(row);
          });
        },

        // Get status color for badges
        getStatusColor(status) {
          switch (status) {
            case "active":
              return "success";
            case "pending":
              return "warning";
            case "suspended":
              return "danger";
            default:
              return "secondary";
          }
        },

        // Update plan filter options
        updatePlanFilter() {
          const planFilter = document.getElementById("tenantPlanFilter");
          const plans = [...new Set(this.data.tenants.map((t) => t.plan))];

          // Clear existing options except "All Plans"
          planFilter.innerHTML = '<option value="">All Plans</option>';

          plans.forEach((plan) => {
            const option = document.createElement("option");
            option.value = plan;
            option.textContent = plan.charAt(0).toUpperCase() + plan.slice(1);
            planFilter.appendChild(option);
          });
        },

        // Load plans
        async loadPlans() {
          try {
            const response = await fetch("/master-admin/plans");
            const result = await response.json();

            if (!result.success) {
              throw new Error(result.message || "Failed to load plans");
            }

            this.data.plans = result.plans;
            this.renderPlans(result.plans);
          } catch (error) {
            console.error("Failed to load plans:", error);
            this.showAlert("danger", "Failed to load plans");
          }
        },

        // Render plans table
        renderPlans(plans) {
          const tbody = document.getElementById("plansTableBody");
          tbody.innerHTML = "";

          plans.forEach((plan) => {
            const row = document.createElement("tr");

            // Handle features - check if it's an object or array
            let featuresHtml = "";
            if (plan.features) {
              if (Array.isArray(plan.features)) {
                // If it's an array, use the original logic
                featuresHtml = plan.features
                  .slice(0, 3)
                  .map(
                    (f) => `<span class="badge bg-secondary me-1">${f}</span>`
                  )
                  .join("");
                if (plan.features.length > 3) {
                  featuresHtml += `<span class="text-muted">+${
                    plan.features.length - 3
                  } more</span>`;
                }
              } else if (typeof plan.features === "object") {
                // If it's an object, convert to key-value display
                const featureEntries = Object.entries(plan.features);
                featuresHtml = featureEntries
                  .slice(0, 3)
                  .map(([key, value]) => {
                    const displayValue =
                      typeof value === "boolean" ? (value ? "✓" : "✗") : value;
                    return `<span class="badge bg-secondary me-1">${key}: ${displayValue}</span>`;
                  })
                  .join("");
                if (featureEntries.length > 3) {
                  featuresHtml += `<span class="text-muted">+${
                    featureEntries.length - 3
                  } more</span>`;
                }
              }
            }

            row.innerHTML = `
      <td><strong>${plan.name}</strong></td>
      <td>$${plan.price}</td>
      <td>${plan.max_users}</td>
      <td>${plan.storage_limit} MB</td>
      <td>${featuresHtml}</td>
      <td><span class="badge bg-info">${plan.tenant_count || 0}</span></td>
      <td>
        <span class="badge bg-${plan.is_active ? "success" : "danger"}">
          ${plan.is_active ? "Active" : "Inactive"}
        </span>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-sm btn-primary" 
                  onclick="Dashboard.editPlan(${plan.id})"
                  title="Edit">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-danger" 
                  onclick="Dashboard.deletePlan(${plan.id})"
                  title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    `;
            tbody.appendChild(row);
          });
        },

        // Add this function to the Dashboard object, after the createPlan function:

        async editPlan(planId) {
          try {
            // First, get the plan data
            const response = await fetch(`/master-admin/plan/${planId}/edit`);
            const result = await response.json();

            if (!result.success) {
              this.showAlert(
                "danger",
                result.message || "Failed to load plan data"
              );
              return;
            }

            const plan = result.plan;

            // Populate the form with existing data
            const form = document.getElementById("createPlanForm");
            form.querySelector('input[name="name"]').value = plan.name;
            form.querySelector('input[name="price"]').value = plan.price;
            form.querySelector('input[name="max_users"]').value =
              plan.max_users;
            form.querySelector('input[name="storage_limit"]').value =
              plan.storage_limit;

            // Handle features - convert object to comma-separated string if needed
            let featuresText = "";
            if (plan.features) {
              if (Array.isArray(plan.features)) {
                featuresText = plan.features.join(", ");
              } else if (typeof plan.features === "object") {
                featuresText = Object.entries(plan.features)
                  .map(([key, value]) => `${key}: ${value}`)
                  .join(", ");
              }
            }
            form.querySelector('textarea[name="features"]').value =
              featuresText;

            // Handle modules
            const modulesText = Array.isArray(plan.modules)
              ? plan.modules.join(", ")
              : "";
            form.querySelector('textarea[name="modules"]').value = modulesText;

            form.querySelector('input[name="is_active"]').checked =
              plan.is_active;

            // Change modal title and button
            document.querySelector(
              "#createPlanModal .modal-title"
            ).textContent = "Edit Plan";
            document.querySelector("#createPlanModal .btn-primary").onclick =
              () => this.updatePlan(planId);
            document.querySelector(
              "#createPlanModal .btn-primary"
            ).textContent = "Update Plan";

            // Show the modal
            const modal = new bootstrap.Modal(
              document.getElementById("createPlanModal")
            );
            modal.show();

            // Reset modal when closed
            document.getElementById("createPlanModal").addEventListener(
              "hidden.bs.modal",
              () => {
                document.querySelector(
                  "#createPlanModal .modal-title"
                ).textContent = "Create New Plan";
                document.querySelector(
                  "#createPlanModal .btn-primary"
                ).onclick = () => this.createPlan();
                document.querySelector(
                  "#createPlanModal .btn-primary"
                ).textContent = "Create Plan";
                form.reset();
              },
              { once: true }
            );
          } catch (error) {
            console.error("Failed to edit plan:", error);
            this.showAlert("danger", "Failed to load plan for editing");
          }
        },

        async updatePlan(planId) {
          try {
            const form = document.getElementById("createPlanForm");
            const formData = new FormData(form);

            // Parse features back to appropriate format
            const featuresText = formData.get("features");
            let features = [];
            if (featuresText) {
              // Try to parse as key-value pairs, fallback to simple array
              if (featuresText.includes(":")) {
                features = {};
                featuresText.split(",").forEach((item) => {
                  const [key, value] = item.split(":").map((s) => s.trim());
                  if (key && value !== undefined) {
                    // Try to parse boolean values
                    if (value === "true") features[key] = true;
                    else if (value === "false") features[key] = false;
                    else features[key] = value;
                  }
                });
              } else {
                features = featuresText
                  .split(",")
                  .map((f) => f.trim())
                  .filter((f) => f);
              }
            }

            const planData = {
              name: formData.get("name"),
              price: parseFloat(formData.get("price")),
              max_users: parseInt(formData.get("max_users")),
              storage_limit: parseInt(formData.get("storage_limit")),
              features: features,
              modules: formData.get("modules")
                ? formData
                    .get("modules")
                    .split(",")
                    .map((m) => m.trim())
                    .filter((m) => m)
                : [],
              is_active: formData.has("is_active"),
            };

            this.showLoading();
            const response = await fetch(
              `/master-admin/plan/${planId}/update`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(planData),
              }
            );
            const result = await response.json();

            if (result.success) {
              this.showAlert("success", result.message);
              bootstrap.Modal.getInstance(
                document.getElementById("createPlanModal")
              ).hide();
              await this.loadPlans();
            } else {
              this.showAlert("danger", result.message);
            }
          } catch (error) {
            console.error("Failed to update plan:", error);
            this.showAlert("danger", "Failed to update plan");
          } finally {
            this.hideLoading();
          }
        },

        // Load analytics
        async loadAnalytics() {
          try {
            const response = await fetch("/master-admin/api/admin/analytics");
            const result = await response.json();

            if (!result.success) {
              throw new Error(result.message || "Failed to load analytics");
            }

            this.data.analytics = result.analytics;
          } catch (error) {
            console.error("Failed to load analytics:", error);
            this.showAlert("warning", "Failed to load analytics data");
          }
        },

        // Initialize charts
        initCharts() {
          try {
            this.initUserGrowthChart();
            this.initPlanDistributionChart();
            this.initRevenueChart();
            this.initStorageChart();
          } catch (error) {
            console.error("Failed to initialize charts:", error);
          }
        },

        // User Growth Chart
        initUserGrowthChart() {
          const ctx = document
            .getElementById("userGrowthChart")
            .getContext("2d");
          const data = this.data.analytics.userGrowth || {
            labels: [],
            data: [],
          };

          this.charts.userGrowth = new Chart(ctx, {
            type: "line",
            data: {
              labels: data.labels,
              datasets: [
                {
                  label: "Users",
                  data: data.data,
                  borderColor: "#667eea",
                  backgroundColor: "rgba(102, 126, 234, 0.1)",
                  fill: true,
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true },
              },
            },
          });
        },

        // Plan Distribution Chart
        initPlanDistributionChart() {
          const ctx = document
            .getElementById("planDistributionChart")
            .getContext("2d");
          const data = this.data.analytics.planDistribution || {
            labels: ["No Data"],
            data: [1],
          };

          this.charts.planDistribution = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: data.labels,
              datasets: [
                {
                  data: data.data,
                  backgroundColor: [
                    "#28a745",
                    "#ffc107",
                    "#dc3545",
                    "#17a2b8",
                    "#6f42c1",
                  ],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: "bottom" } },
            },
          });
        },

        // Revenue Chart
        initRevenueChart() {
          const ctx = document.getElementById("revenueChart").getContext("2d");
          const data = this.data.analytics.revenue || { labels: [], data: [] };

          this.charts.revenue = new Chart(ctx, {
            type: "bar",
            data: {
              labels: data.labels,
              datasets: [
                {
                  label: "Revenue ($)",
                  data: data.data,
                  backgroundColor: "#667eea",
                  borderRadius: 8,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true },
              },
            },
          });
        },

        // Storage Chart
        initStorageChart() {
          const ctx = document.getElementById("storageChart").getContext("2d");
          const data = this.data.analytics.storage || { labels: [], data: [] };

          this.charts.storage = new Chart(ctx, {
            type: "line",
            data: {
              labels: data.labels,
              datasets: [
                {
                  label: "Storage (TB)",
                  data: data.data,
                  borderColor: "#28a745",
                  backgroundColor: "rgba(40, 167, 69, 0.1)",
                  fill: true,
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true },
              },
            },
          });
        },

        // Event listeners
        setupEventListeners() {
          // Tab switching
          document.querySelectorAll('[data-bs-toggle="tab"]').forEach((tab) => {
            tab.addEventListener("shown.bs.tab", (e) => {
              const tabId = e.target.getAttribute("href").substring(1);
              this.onTabSwitch(tabId);
            });
          });

          // Keyboard shortcuts
          document.addEventListener("keydown", (e) => {
            if (e.ctrlKey || e.metaKey) {
              switch (e.key) {
                case "r":
                  e.preventDefault();
                  this.refreshAll();
                  break;
              }
            }
          });
        },

        // Tab switch handler
        onTabSwitch(tabId) {
          // Resize charts when analytics tab is shown
          if (tabId === "analytics") {
            setTimeout(() => {
              Object.values(this.charts).forEach((chart) => {
                if (chart && chart.resize) chart.resize();
              });
            }, 100);
          }
        },

        // User Actions
        async toggleUserStatus(userId) {
          try {
            this.showLoading();
            const response = await fetch(
              `/master-admin/user/${userId}/toggle_status`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
              }
            );
            const result = await response.json();

            if (result.success) {
              this.showAlert("success", result.message);
              await this.loadUsers();
              await this.loadStats();
            } else {
              this.showAlert("danger", result.message);
            }
          } catch (error) {
            this.showAlert("danger", "Failed to update user status");
          } finally {
            this.hideLoading();
          }
        },

        // Replace the existing viewUserDetails function with this:
        async viewUserDetails(userId) {
          try {
            this.showLoading();
            const response = await fetch(
              `/master-admin/user/${userId}/details`
            );
            const result = await response.json();

            if (!result.success) {
              this.showAlert(
                "danger",
                result.message || "Failed to load user details"
              );
              return;
            }

            const user = result.user;

            // Create and show user details modal
            this.showUserDetailsModal(user);
          } catch (error) {
            console.error("Failed to load user details:", error);
            this.showAlert("danger", "Failed to load user details");
          } finally {
            this.hideLoading();
          }
        },

        // Add this new function to create and show the user details modal:
        showUserDetailsModal(user) {
          // Create modal HTML
          const modalHtml = `
    <div class="modal fade" id="userDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-user"></i> User Details: ${user.username}
              ${
                user.is_admin
                  ? '<span class="badge bg-primary ms-2">ADMIN</span>'
                  : ""
              }
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <h6><i class="fas fa-info-circle"></i> Basic Information</h6>
                <table class="table table-sm">
                  <tr>
                    <td><strong>Username:</strong></td>
                    <td>${user.username}</td>
                  </tr>
                  <tr>
                    <td><strong>Email:</strong></td>
                    <td>${user.email}</td>
                  </tr>
                  <tr>
                    <td><strong>Status:</strong></td>
                    <td>
                      <span class="badge bg-${
                        user.is_active ? "success" : "danger"
                      }">
                        ${user.is_active ? "Active" : "Inactive"}
                      </span>
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Role:</strong></td>
                    <td>
                      <span class="badge bg-${
                        user.is_admin ? "primary" : "secondary"
                      }">
                        ${user.is_admin ? "Admin" : "User"}
                      </span>
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Last Login:</strong></td>
                    <td>${
                      user.last_login
                        ? new Date(user.last_login).toLocaleString()
                        : "Never"
                    }</td>
                  </tr>
                  <tr>
                    <td><strong>Created:</strong></td>
                    <td>${
                      user.created_at
                        ? new Date(user.created_at).toLocaleString()
                        : "Unknown"
                    }</td>
                  </tr>
                </table>
              </div>
              <div class="col-md-6">
                <h6><i class="fas fa-building"></i> Tenants (${
                  user.tenants.length
                })</h6>
                ${
                  user.tenants.length > 0
                    ? `
                  <div style="max-height: 200px; overflow-y: auto;">
                    ${user.tenants
                      .map(
                        (tenant) => `
                      <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content-between">
                          <strong>${tenant.name}</strong>
                          <span class="badge bg-${this.getStatusColor(
                            tenant.status
                          )}">${tenant.status}</span>
                        </div>
                        <small class="text-muted">${
                          tenant.subdomain
                        }</small><br>
                        <small><strong>Role:</strong> ${tenant.role}</small><br>
                        <small><strong>Plan:</strong> ${tenant.plan}</small>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                `
                    : '<p class="text-muted">No tenants associated</p>'
                }
              </div>
            </div>
            
            <hr>
            
            <h6><i class="fas fa-history"></i> Recent Activity (${
              user.recent_activity.length
            })</h6>
            ${
              user.recent_activity.length > 0
                ? `
              <div style="max-height: 250px; overflow-y: auto;">
                <table class="table table-sm table-hover">
                  <thead>
                    <tr>
                      <th>Date/Time</th>
                      <th>Tenant</th>
                      <th>IP Address</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${user.recent_activity
                      .map(
                        (activity) => `
                      <tr>
                        <td><small>${new Date(
                          activity.accessed_at
                        ).toLocaleString()}</small></td>
                        <td><small>${activity.tenant_name}</small></td>
                        <td><small>${activity.ip_address}</small></td>
                        <td>
                          <span class="badge bg-${
                            activity.success ? "success" : "danger"
                          }">
                            ${activity.success ? "Success" : "Failed"}
                          </span>
                        </td>
                      </tr>
                    `
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
            `
                : '<p class="text-muted">No recent activity</p>'
            }
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-warning" onclick="Dashboard.resetUserPassword(${
              user.id
            })">
              <i class="fas fa-key"></i> Reset Password
            </button>
            <button type="button" class="btn btn-${
              user.is_active ? "danger" : "success"
            }" 
                    onclick="Dashboard.toggleUserStatus(${user.id})">
              <i class="fas fa-${user.is_active ? "pause" : "play"}"></i> 
              ${user.is_active ? "Deactivate" : "Activate"}
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

          // Remove existing modal if present
          const existingModal = document.getElementById("userDetailsModal");
          if (existingModal) {
            existingModal.remove();
          }

          // Add modal to body
          document.body.insertAdjacentHTML("beforeend", modalHtml);

          // Show modal
          const modal = new bootstrap.Modal(
            document.getElementById("userDetailsModal")
          );
          modal.show();

          // Clean up when modal is hidden
          document
            .getElementById("userDetailsModal")
            .addEventListener("hidden.bs.modal", function () {
              this.remove();
            });
        },

        async resetUserPassword(userId) {
          if (confirm("Are you sure you want to reset this user's password?")) {
            try {
              this.showLoading();
              const response = await fetch(
                `/master-admin/user/${userId}/reset_password`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert(
                  "success",
                  `Password reset successfully. New password: ${result.new_password}`
                );
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Failed to reset password");
            } finally {
              this.hideLoading();
            }
          }
        },

        // Tenant Actions
        async toggleTenantStatus(tenantId) {
          if (
            confirm("Are you sure you want to change this tenant's status?")
          ) {
            try {
              this.showLoading();
              const response = await fetch(
                `/master-admin/tenant/${tenantId}/toggle_status`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
                await this.loadTenants();
                await this.loadStats();
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Failed to update tenant status");
            } finally {
              this.hideLoading();
            }
          }
        },

        // Replace the existing viewTenantDetails function with this:
        async viewTenantDetails(tenantId) {
          try {
            this.showLoading();
            const response = await fetch(
              `/master-admin/tenant/${tenantId}/details`
            );
            const result = await response.json();

            if (!result.success) {
              this.showAlert(
                "danger",
                result.message || "Failed to load tenant details"
              );
              return;
            }

            const tenant = result.tenant;

            // Create and show tenant details modal
            this.showTenantDetailsModal(tenant);
          } catch (error) {
            console.error("Failed to load tenant details:", error);
            this.showAlert("danger", "Failed to load tenant details");
          } finally {
            this.hideLoading();
          }
        },

        // Add this new function to create and show the tenant details modal:
        showTenantDetailsModal(tenant) {
          // Create modal HTML
          const modalHtml = `
    <div class="modal fade" id="tenantDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-building"></i> Tenant Details: ${tenant.name}
              <span class="badge bg-${this.getStatusColor(
                tenant.status
              )} ms-2">${tenant.status.toUpperCase()}</span>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <!-- Basic Information -->
              <div class="col-md-6">
                <h6><i class="fas fa-info-circle"></i> Basic Information</h6>
                <table class="table table-sm">
                  <tr>
                    <td><strong>Name:</strong></td>
                    <td>${tenant.name}</td>
                  </tr>
                  <tr>
                    <td><strong>Subdomain:</strong></td>
                    <td>
                      <code>${tenant.subdomain}</code>
                      <a href="http://${tenant.subdomain}.${
            window.location.hostname
          }" target="_blank" class="ms-2">
                        <i class="fas fa-external-link-alt"></i>
                      </a>
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Database:</strong></td>
                    <td><code>${tenant.database_name}</code></td>
                  </tr>
                  <tr>
                    <td><strong>Admin Username:</strong></td>
                    <td><code>${tenant.admin_username}</code></td>
                  </tr>
                  <tr>
                    <td><strong>Status:</strong></td>
                    <td>
                      <span class="badge bg-${this.getStatusColor(
                        tenant.status
                      )}">
                        ${tenant.status.toUpperCase()}
                      </span>
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Created:</strong></td>
                    <td>${
                      tenant.created_at
                        ? new Date(tenant.created_at).toLocaleString()
                        : "Unknown"
                    }</td>
                  </tr>
                  <tr>
                    <td><strong>Last Updated:</strong></td>
                    <td>${
                      tenant.updated_at
                        ? new Date(tenant.updated_at).toLocaleString()
                        : "Unknown"
                    }</td>
                  </tr>
                </table>
              </div>

              <!-- Plan & Resources -->
              <div class="col-md-6">
                <h6><i class="fas fa-tags"></i> Plan & Resources</h6>
                <table class="table table-sm">
                  <tr>
                    <td><strong>Plan:</strong></td>
                    <td>
                      <span class="badge bg-primary">${tenant.plan.toUpperCase()}</span>
                      ${
                        tenant.plan_details
                          ? `($${tenant.plan_details.price}/month)`
                          : ""
                      }
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Max Users:</strong></td>
                    <td>${
                      tenant.max_users ||
                      (tenant.plan_details
                        ? tenant.plan_details.max_users
                        : "N/A")
                    }</td>
                  </tr>
                  <tr>
                    <td><strong>Storage Limit:</strong></td>
                    <td>${
                      tenant.storage_limit ||
                      (tenant.plan_details
                        ? tenant.plan_details.storage_limit + " MB"
                        : "N/A")
                    }</td>
                  </tr>
                  <tr>
                    <td><strong>Storage Used:</strong></td>
                    <td>${tenant.storage_usage}</td>
                  </tr>
                  <tr>
                    <td><strong>Current Users:</strong></td>
                    <td>${tenant.user_count}</td>
                  </tr>
                  <tr>
                    <td><strong>Installed Apps:</strong></td>
                    <td>${tenant.installed_apps.length} apps</td>
                  </tr>
                  ${
                    tenant.plan_details && tenant.plan_details.features
                      ? `
                  <tr>
                    <td><strong>Plan Features:</strong></td>
                    <td>
                      ${
                        typeof tenant.plan_details.features === "object"
                          ? Object.entries(tenant.plan_details.features)
                              .map(
                                ([key, value]) =>
                                  `<small class="badge bg-secondary me-1">${key}: ${value}</small>`
                              )
                              .join("")
                          : tenant.plan_details.features
                              .map(
                                (f) =>
                                  `<small class="badge bg-secondary me-1">${f}</small>`
                              )
                              .join("")
                      }
                    </td>
                  </tr>
                  `
                      : ""
                  }
                </table>
              </div>
            </div>
            
            <hr>
            
            <!-- Users Tab -->
            <div class="row">
              <div class="col-md-6">
                <h6><i class="fas fa-users"></i> Users (${
                  tenant.user_count
                })</h6>
                ${
                  tenant.users.length > 0
                    ? `
                  <div style="max-height: 250px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                      <thead>
                        <tr>
                          <th>Username</th>
                          <th>Role</th>
                          <th>Status</th>
                          <th>Last Login</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${tenant.users
                          .map(
                            (user) => `
                          <tr>
                            <td>
                              <strong>${user.username}</strong><br>
                              <small class="text-muted">${user.email}</small>
                            </td>
                            <td>
                              <span class="badge bg-${
                                user.role === "admin" ? "primary" : "secondary"
                              }">
                                ${user.role.toUpperCase()}
                              </span>
                            </td>
                            <td>
                              <span class="badge bg-${
                                user.is_active ? "success" : "danger"
                              }">
                                ${user.is_active ? "Active" : "Inactive"}
                              </span>
                            </td>
                            <td>
                              <small>${
                                user.last_login
                                  ? new Date(user.last_login).toLocaleString()
                                  : "Never"
                              }</small>
                            </td>
                          </tr>
                        `
                          )
                          .join("")}
                      </tbody>
                    </table>
                  </div>
                `
                    : '<p class="text-muted">No users found</p>'
                }
              </div>
              
              <!-- Installed Apps -->
              <div class="col-md-6">
                <h6><i class="fas fa-puzzle-piece"></i> Installed Apps (${
                  tenant.installed_apps.length
                })</h6>
                ${
                  tenant.installed_apps.length > 0
                    ? `
                  <div style="max-height: 250px; overflow-y: auto;">
                    <div class="row g-2">
                      ${tenant.installed_apps
                        .map(
                          (app) => `
                        <div class="col-6">
                          <div class="border rounded p-2">
                            <small><strong>${
                              app.display_name || app.name
                            }</strong></small><br>
                            <small class="text-muted">${
                              app.technical_name || app.name
                            }</small><br>
                            ${
                              app.version
                                ? `<small class="text-info">v${app.version}</small>`
                                : ""
                            }
                          </div>
                        </div>
                      `
                        )
                        .join("")}
                    </div>
                  </div>
                `
                    : '<p class="text-muted">No apps installed or tenant inactive</p>'
                }
              </div>
            </div>
            
            <hr>
            
            <!-- Access Logs -->
            <h6><i class="fas fa-history"></i> Recent Access Logs (${
              tenant.access_logs.length
            })</h6>
            ${
              tenant.access_logs.length > 0
                ? `
              <div style="max-height: 300px; overflow-y: auto;">
                <table class="table table-sm table-hover">
                  <thead>
                    <tr>
                      <th>Date/Time</th>
                      <th>User</th>
                      <th>IP Address</th>
                      <th>Status</th>
                      <th>User Agent</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${tenant.access_logs
                      .map(
                        (log) => `
                      <tr>
                        <td><small>${new Date(
                          log.accessed_at
                        ).toLocaleString()}</small></td>
                        <td><small>${log.username}</small></td>
                        <td><small><code>${log.ip_address}</code></small></td>
                        <td>
                          <span class="badge bg-${
                            log.success ? "success" : "danger"
                          }">
                            ${log.success ? "Success" : "Failed"}
                          </span>
                        </td>
                        <td><small class="text-muted">${
                          log.user_agent
                            ? log.user_agent.substring(0, 50) + "..."
                            : "N/A"
                        }</small></td>
                      </tr>
                    `
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
            `
                : '<p class="text-muted">No access logs found</p>'
            }
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-info" onclick="Dashboard.resetTenantAdminPassword(${
              tenant.id
            })">
              <i class="fas fa-key"></i> Reset Admin Password
            </button>
            <button type="button" class="btn btn-warning" onclick="Dashboard.backupTenant(${
              tenant.id
            })">
              <i class="fas fa-download"></i> Backup
            </button>
            <button type="button" class="btn btn-${
              tenant.status === "active" ? "danger" : "success"
            }" 
                    onclick="Dashboard.toggleTenantStatus(${tenant.id})">
              <i class="fas fa-${
                tenant.status === "active" ? "pause" : "play"
              }"></i> 
              ${tenant.status === "active" ? "Deactivate" : "Activate"}
            </button>
            ${
              tenant.status === "pending"
                ? `
              <button type="button" class="btn btn-success" onclick="Dashboard.approveTenant(${tenant.id})">
                <i class="fas fa-check"></i> Approve
              </button>
            `
                : ""
            }
          </div>
        </div>
      </div>
    </div>
  `;

          // Remove existing modal if present
          const existingModal = document.getElementById("tenantDetailsModal");
          if (existingModal) {
            existingModal.remove();
          }

          // Add modal to body
          document.body.insertAdjacentHTML("beforeend", modalHtml);

          // Show modal
          const modal = new bootstrap.Modal(
            document.getElementById("tenantDetailsModal")
          );
          modal.show();

          // Clean up when modal is hidden
          document
            .getElementById("tenantDetailsModal")
            .addEventListener("hidden.bs.modal", function () {
              this.remove();
            });
        },

        // Add this function for resetting tenant admin password:
        async resetTenantAdminPassword(tenantId) {
          if (
            confirm(
              "Are you sure you want to reset this tenant's admin password?"
            )
          ) {
            try {
              this.showLoading();
              const response = await fetch(
                `/master-admin/tenant/${tenantId}/reset_admin_password`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert(
                  "success",
                  `Admin password reset successfully. New password: ${result.new_password}`
                );
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Failed to reset admin password");
            } finally {
              this.hideLoading();
            }
          }
        },

        async backupTenant(tenantId) {
          if (confirm("Are you sure you want to backup this tenant?")) {
            try {
              this.showLoading();
              const response = await fetch(
                `/master-admin/tenant/${tenantId}/backup`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Failed to backup tenant");
            } finally {
              this.hideLoading();
            }
          }
        },

        async approveTenant(tenantId) {
          if (confirm("Are you sure you want to approve this tenant?")) {
            try {
              this.showLoading();
              const response = await fetch(
                `/master-admin/tenant/${tenantId}/force_activate`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ reason: "Manual approval by admin" }),
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
                await this.loadTenants();
                await this.loadStats();
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Failed to approve tenant");
            } finally {
              this.hideLoading();
            }
          }
        },

        // Plan Actions
        showCreatePlanModal() {
          const modal = new bootstrap.Modal(
            document.getElementById("createPlanModal")
          );
          modal.show();
        },

        async createPlan() {
          try {
            const form = document.getElementById("createPlanForm");
            const formData = new FormData(form);

            const planData = {
              name: formData.get("name"),
              price: parseFloat(formData.get("price")),
              max_users: parseInt(formData.get("max_users")),
              storage_limit: parseInt(formData.get("storage_limit")),
              features: formData.get("features")
                ? formData
                    .get("features")
                    .split(",")
                    .map((f) => f.trim())
                : [],
              modules: formData.get("modules")
                ? formData
                    .get("modules")
                    .split(",")
                    .map((m) => m.trim())
                : [],
              is_active: formData.has("is_active"),
            };

            this.showLoading();
            const response = await fetch("/master-admin/plan/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(planData),
            });
            const result = await response.json();

            if (result.success) {
              this.showAlert("success", result.message);
              bootstrap.Modal.getInstance(
                document.getElementById("createPlanModal")
              ).hide();
              form.reset();
              await this.loadPlans();
            } else {
              this.showAlert("danger", result.message);
            }
          } catch (error) {
            this.showAlert("danger", "Failed to create plan");
          } finally {
            this.hideLoading();
          }
        },

        async deletePlan(planId) {
          if (
            confirm(
              "Are you sure you want to delete this plan? This action cannot be undone."
            )
          ) {
            try {
              this.showLoading();
              const response = await fetch(
                `/master-admin/plan/${planId}/delete`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
                await this.loadPlans();
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Failed to delete plan");
            } finally {
              this.hideLoading();
            }
          }
        },

        // System Operations
        async performHealthCheck() {
          try {
            this.showLoading();
            const response = await fetch(
              "/master-admin/operations/health_check",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
              }
            );
            const result = await response.json();

            if (result.success) {
              this.showAlert(
                "success",
                `Health Check Complete: CPU ${result.results.cpu_percent}%, Memory ${result.results.memory.percent}%`
              );
            } else {
              this.showAlert("danger", result.message);
            }
          } catch (error) {
            this.showAlert("danger", "Health check failed");
          } finally {
            this.hideLoading();
          }
        },

        async performDatabaseBackup() {
          if (
            confirm("Are you sure you want to perform a full database backup?")
          ) {
            try {
              this.showLoading();
              const response = await fetch(
                "/master-admin/operations/database_backup",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Database backup failed");
            } finally {
              this.hideLoading();
            }
          }
        },

        async optimizeDatabase() {
          if (confirm("Are you sure you want to optimize the database?")) {
            try {
              this.showLoading();
              const response = await fetch(
                "/master-admin/operations/database_optimize",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Database optimization failed");
            } finally {
              this.hideLoading();
            }
          }
        },

        async cleanDatabase() {
          if (confirm("Are you sure you want to clean the database?")) {
            try {
              this.showLoading();
              const response = await fetch(
                "/master-admin/operations/database_cleanup",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Database cleanup failed");
            } finally {
              this.hideLoading();
            }
          }
        },

        async runMigrations() {
          if (confirm("Are you sure you want to run database migrations?")) {
            try {
              this.showLoading();
              const response = await fetch(
                "/master-admin/operations/database_migrate",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Database migration failed");
            } finally {
              this.hideLoading();
            }
          }
        },

        async clearCache() {
          if (confirm("Are you sure you want to clear system cache?")) {
            try {
              this.showLoading();
              const response = await fetch(
                "/master-admin/operations/clear_cache",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Cache clear failed");
            } finally {
              this.hideLoading();
            }
          }
        },

        async restartServices() {
          if (confirm("Are you sure you want to restart services?")) {
            try {
              this.showLoading();
              const response = await fetch(
                "/master-admin/operations/restart_services",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Service restart failed");
            } finally {
              this.hideLoading();
            }
          }
        },

        async updateSystem() {
          if (confirm("Are you sure you want to update the system?")) {
            try {
              this.showLoading();
              const response = await fetch(
                "/master-admin/operations/update_system",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "System update failed");
            } finally {
              this.hideLoading();
            }
          }
        },

        // Load audit logs
        async loadAuditLogs() {
          try {
            const response = await fetch("/master-admin/audit-logs");
            const result = await response.json();

            if (result.success) {
              this.renderAuditLogs(result.logs);
              this.renderRecentActivity(result.logs.slice(0, 10));
            } else {
              this.showAlert("warning", "Failed to load audit logs");
            }
          } catch (error) {
            console.error("Failed to load audit logs:", error);
          }
        },

        // Render audit logs
        renderAuditLogs(logs) {
          const container = document.getElementById("audit-logs-container");
          container.innerHTML = "";

          if (logs.length === 0) {
            container.innerHTML =
              '<p class="text-muted">No audit logs found.</p>';
            return;
          }

          logs.forEach((log) => {
            const logElement = document.createElement("div");
            logElement.className =
              "border-start border-4 border-primary p-3 mb-2 bg-light";
            logElement.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <strong>${log.action}</strong>
                            <small class="text-muted">${log.created_at}</small>
                        </div>
                        <div class="mt-1">
                            <small><strong>User:</strong> ${
                              log.username
                            }</small>
                            ${
                              log.tenant_name
                                ? `<small class="ms-3"><strong>Tenant:</strong> ${log.tenant_name}</small>`
                                : ""
                            }
                        </div>
                        ${
                          log.details
                            ? `<div class="mt-1"><small class="text-muted">${JSON.stringify(
                                log.details
                              )}</small></div>`
                            : ""
                        }
                    `;
            container.appendChild(logElement);
          });
        },

        // Render recent activity
        renderRecentActivity(logs) {
          const container = document.getElementById("recent-activity");
          container.innerHTML = "";

          if (logs.length === 0) {
            container.innerHTML =
              '<p class="text-muted">No recent activity.</p>';
            return;
          }

          logs.forEach((log) => {
            const activityElement = document.createElement("div");
            activityElement.className = "border-bottom pb-2 mb-2";
            activityElement.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <span>${log.action}</span>
                            <small class="text-muted">${log.created_at}</small>
                        </div>
                        <small class="text-muted">by ${log.username}</small>
                    `;
            container.appendChild(activityElement);
          });
        },

        // Filtering functions
        filterUsers() {
          const searchTerm = document
            .getElementById("userSearch")
            .value.toLowerCase();
          const statusFilter =
            document.getElementById("userStatusFilter").value;
          const adminFilter = document.getElementById("userAdminFilter").value;

          const rows = document.querySelectorAll("#usersTable tbody tr");

          rows.forEach((row) => {
            const username = row
              .querySelector("td:nth-child(2) strong")
              .textContent.toLowerCase();
            const email = row
              .querySelector("td:nth-child(2) small")
              .textContent.toLowerCase();
            const status = row
              .querySelector("td:nth-child(3) .badge")
              .textContent.toLowerCase();
            const isAdmin = row.querySelector(".badge.bg-primary") !== null;

            let showRow = true;

            if (
              searchTerm &&
              !username.includes(searchTerm) &&
              !email.includes(searchTerm)
            ) {
              showRow = false;
            }

            if (statusFilter && !status.includes(statusFilter)) {
              showRow = false;
            }

            if (adminFilter === "admin" && !isAdmin) {
              showRow = false;
            } else if (adminFilter === "user" && isAdmin) {
              showRow = false;
            }

            row.style.display = showRow ? "" : "none";
          });
        },

        filterTenants() {
          const searchTerm = document
            .getElementById("tenantSearch")
            .value.toLowerCase();
          const statusFilter =
            document.getElementById("tenantStatusFilter").value;
          const planFilter = document.getElementById("tenantPlanFilter").value;

          const rows = document.querySelectorAll("#tenantsTable tbody tr");

          rows.forEach((row) => {
            const name = row
              .querySelector("td:nth-child(2) strong")
              .textContent.toLowerCase();
            const subdomain = row
              .querySelector("td:nth-child(2) small")
              .textContent.toLowerCase();
            const status = row
              .querySelector("td:nth-child(3) .badge")
              .textContent.toLowerCase();
            const plan = row
              .querySelector("td:nth-child(4) .badge")
              .textContent.toLowerCase();

            let showRow = true;

            if (
              searchTerm &&
              !name.includes(searchTerm) &&
              !subdomain.includes(searchTerm)
            ) {
              showRow = false;
            }

            if (statusFilter && !status.includes(statusFilter)) {
              showRow = false;
            }

            if (planFilter && !plan.includes(planFilter)) {
              showRow = false;
            }

            row.style.display = showRow ? "" : "none";
          });
        },

        // Toggle selection functions
        toggleAllUsers() {
          const selectAll = document.getElementById("selectAllUsers");
          const checkboxes = document.querySelectorAll(".user-checkbox");
          checkboxes.forEach((cb) => (cb.checked = selectAll.checked));
        },

        toggleAllTenants() {
          const selectAll = document.getElementById("selectAllTenants");
          const checkboxes = document.querySelectorAll(".tenant-checkbox");
          checkboxes.forEach((cb) => (cb.checked = selectAll.checked));
        },

        // Bulk actions
        async bulkUserActions() {
          const selected = Array.from(
            document.querySelectorAll(".user-checkbox:checked")
          ).map((cb) => cb.value);
          if (selected.length === 0) {
            this.showAlert("warning", "Please select users first");
            return;
          }

          const action = prompt("Enter action (activate/deactivate/delete):");
          if (
            action &&
            confirm(
              `Are you sure you want to ${action} ${selected.length} users?`
            )
          ) {
            try {
              this.showLoading();
              const response = await fetch("/master-admin/users/bulk_action", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action, user_ids: selected }),
              });
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
                await this.loadUsers();
                await this.loadStats();
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Bulk action failed");
            } finally {
              this.hideLoading();
            }
          }
        },

        async bulkTenantActions() {
          const selected = Array.from(
            document.querySelectorAll(".tenant-checkbox:checked")
          ).map((cb) => cb.value);
          if (selected.length === 0) {
            this.showAlert("warning", "Please select tenants first");
            return;
          }

          const action = prompt(
            "Enter action (activate/deactivate/suspend/backup):"
          );
          if (
            action &&
            confirm(
              `Are you sure you want to ${action} ${selected.length} tenants?`
            )
          ) {
            try {
              this.showLoading();
              const response = await fetch(
                "/master-admin/tenants/bulk_action",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ action, tenant_ids: selected }),
                }
              );
              const result = await response.json();

              if (result.success) {
                this.showAlert("success", result.message);
                await this.loadTenants();
                await this.loadStats();
              } else {
                this.showAlert("danger", result.message);
              }
            } catch (error) {
              this.showAlert("danger", "Bulk action failed");
            } finally {
              this.hideLoading();
            }
          }
        },

        // Export functions
        async exportUsers() {
          try {
            this.showLoading();
            window.location.href = "/master-admin/export/users";
            this.showAlert("success", "Users export initiated");
          } catch (error) {
            this.showAlert("danger", "Failed to export users");
          } finally {
            this.hideLoading();
          }
        },

        async exportTenants() {
          try {
            this.showLoading();
            window.location.href = "/master-admin/export/tenants";
            this.showAlert("success", "Tenants export initiated");
          } catch (error) {
            this.showAlert("danger", "Failed to export tenants");
          } finally {
            this.hideLoading();
          }
        },

        async exportFullSystem() {
          if (confirm("This will export all system data. Continue?")) {
            try {
              this.showLoading();
              window.location.href = "/master-admin/export/full_system";
              this.showAlert("success", "Full system export initiated");
            } catch (error) {
              this.showAlert("danger", "Failed to export system data");
            } finally {
              this.hideLoading();
            }
          }
        },

        // Refresh functions
        async refreshSystemMetrics() {
          try {
            await this.loadStats();
            this.showAlert("info", "System metrics refreshed");
          } catch (error) {
            this.showAlert("danger", "Failed to refresh metrics");
          }
        },

        async refreshAll() {
          try {
            this.showLoading();
            await this.loadAllData();

            // Update charts
            this.updateCharts();

            this.showAlert("success", "All data refreshed successfully");
          } catch (error) {
            this.showAlert("danger", "Failed to refresh data");
          } finally {
            this.hideLoading();
          }
        },

        // Update charts with new data
        updateCharts() {
          try {
            // Update user growth chart
            if (this.charts.userGrowth && this.data.analytics.userGrowth) {
              this.charts.userGrowth.data.labels =
                this.data.analytics.userGrowth.labels;
              this.charts.userGrowth.data.datasets[0].data =
                this.data.analytics.userGrowth.data;
              this.charts.userGrowth.update();
            }

            // Update plan distribution chart
            if (
              this.charts.planDistribution &&
              this.data.analytics.planDistribution
            ) {
              this.charts.planDistribution.data.labels =
                this.data.analytics.planDistribution.labels;
              this.charts.planDistribution.data.datasets[0].data =
                this.data.analytics.planDistribution.data;
              this.charts.planDistribution.update();
            }

            // Update revenue chart
            if (this.charts.revenue && this.data.analytics.revenue) {
              this.charts.revenue.data.labels =
                this.data.analytics.revenue.labels;
              this.charts.revenue.data.datasets[0].data =
                this.data.analytics.revenue.data;
              this.charts.revenue.update();
            }

            // Update storage chart
            if (this.charts.storage && this.data.analytics.storage) {
              this.charts.storage.data.labels =
                this.data.analytics.storage.labels;
              this.charts.storage.data.datasets[0].data =
                this.data.analytics.storage.data;
              this.charts.storage.update();
            }
          } catch (error) {
            console.error("Failed to update charts:", error);
          }
        },

        // Auto refresh
        startAutoRefresh() {
          // Refresh every 30 seconds
          this.refreshInterval = setInterval(async () => {
            try {
              await this.loadStats();
            } catch (error) {
              console.warn("Auto refresh failed:", error);
            }
          }, 30000);
        },

        stopAutoRefresh() {
          if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
          }
        },

        // UI Helpers
        showLoading() {
          document.getElementById("loading-spinner").classList.remove("d-none");
          document.body.classList.add("loading");
        },

        hideLoading() {
          document.getElementById("loading-spinner").classList.add("d-none");
          document.body.classList.remove("loading");
        },

        showAlert(type, message) {
          const alertsContainer = document.getElementById("alerts-container");

          const alertEl = document.createElement("div");
          alertEl.className = `alert alert-${type} alert-dismissible fade show`;
          alertEl.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

          alertsContainer.appendChild(alertEl);

          // Auto-remove after 5 seconds
          setTimeout(() => {
            if (alertEl.parentNode) {
              alertEl.remove();
            }
          }, 5000);
        },
      };

      // Initialize dashboard when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        Dashboard.init();
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", function () {
        Dashboard.stopAutoRefresh();
      });

      // Global error handler
      window.addEventListener("error", function (event) {
        console.error("Dashboard error:", event.error);
        Dashboard.showAlert("danger", "An unexpected error occurred");
      });
    </script>
  </body>
</html>
