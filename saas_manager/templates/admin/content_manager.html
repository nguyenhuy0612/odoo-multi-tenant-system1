{% extends "base.html" %}

{% block title %}Content Manager - {{ super() }}{% endblock %}

{% block head %}
    {{ super() }}
    <meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Content Blocks Management -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h3 class="card-title mb-0">
            <i class="fas fa-edit me-2"></i>Content Blocks
          </h3>
          <button class="btn btn-light btn-sm" onclick="showCreateContentModal()">
            <i class="fas fa-plus me-1"></i>New Content Block
          </button>
        </div>
        <div class="card-body">
          <div id="content-blocks-container">
            <!-- Content blocks will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Categories -->
  <div class="row">
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-folder me-2"></i>Categories</h6>
        </div>
        <div class="card-body">
          <div class="list-group list-group-flush">
            <a href="#" class="list-group-item list-group-item-action" onclick="loadContentByCategory('homepage')">
              <i class="fas fa-home me-2"></i>Homepage
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="loadContentByCategory('about')">
              <i class="fas fa-info-circle me-2"></i>About
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="loadContentByCategory('services')">
              <i class="fas fa-cog me-2"></i>Services
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="loadContentByCategory('contact')">
              <i class="fas fa-phone me-2"></i>Contact
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="loadContentByCategory('footer')">
              <i class="fas fa-layer-group me-2"></i>Footer
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="loadContentByCategory(null)">
              <i class="fas fa-list me-2"></i>All Content
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-9">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Content Editor</h6>
        </div>
        <div class="card-body">
          <div id="content-editor">
            <div class="text-center text-muted py-4">
              <i class="fas fa-mouse-pointer fa-3x mb-3"></i>
              <p>Select a content block to edit or create a new one</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Content Modal -->
<div class="modal fade" id="contentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="contentModalTitle">Create Content Block</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="contentForm">
          <input type="hidden" id="contentId">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="identifier" class="form-label">Identifier</label>
                <input type="text" class="form-control" id="identifier" required>
                <small class="form-text text-muted">Unique identifier (e.g., hero_section, about_text)</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category">
                  <option value="">Select Category</option>
                  <option value="homepage">Homepage</option>
                  <option value="about">About</option>
                  <option value="services">Services</option>
                  <option value="contact">Contact</option>
                  <option value="footer">Footer</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="section" class="form-label">Section</label>
                <select class="form-select" id="section">
                  <option value="">Select Section</option>
                  <option value="header">Header</option>
                  <option value="main">Main</option>
                  <option value="sidebar">Sidebar</option>
                  <option value="footer">Footer</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="contentType" class="form-label">Content Type</label>
                <select class="form-select" id="contentType">
                  <option value="text">Text</option>
                  <option value="html">HTML</option>
                  <option value="markdown">Markdown</option>
                  <option value="json">JSON</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="content" class="form-label">Content</label>
            <textarea class="form-control" id="content" rows="6"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="sortOrder" class="form-label">Sort Order</label>
                <input type="number" class="form-control" id="sortOrder" value="0">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="isActive" checked>
                  <label class="form-check-label" for="isActive">
                    Active
                  </label>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveContent()">Save Content</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentCategory = null;

// Load content blocks on page load
document.addEventListener('DOMContentLoaded', function() {
    loadContentBlocks();
});

function loadContentBlocks(category = null) {
    currentCategory = category;
    const url = category ? `/api/cms/content?category=${category}` : '/api/cms/content';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayContentBlocks(data.content_blocks);
            } else {
                console.error('Failed to load content blocks:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading content blocks:', error);
        });
}

function displayContentBlocks(blocks) {
    const container = document.getElementById('content-blocks-container');
    
    if (blocks.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-file-alt fa-3x mb-3"></i>
                <p>No content blocks found</p>
            </div>
        `;
        return;
    }
    
    const html = blocks.map(block => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-1">${block.title}</h6>
                        <small class="text-muted">ID: ${block.identifier} | Category: ${block.category || 'None'} | Section: ${block.section || 'None'}</small>
                        <p class="mb-1 text-truncate">${block.content || 'No content'}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editContent(${block.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteContent(${block.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ${block.is_active ? '<span class="badge bg-success ms-2">Active</span>' : '<span class="badge bg-secondary ms-2">Inactive</span>'}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function loadContentByCategory(category) {
    loadContentBlocks(category);
    
    // Update active category in sidebar
    const categoryLinks = document.querySelectorAll('.list-group-item');
    categoryLinks.forEach(link => link.classList.remove('active'));
    event.target.classList.add('active');
}

function showCreateContentModal() {
    document.getElementById('contentModalTitle').textContent = 'Create Content Block';
    document.getElementById('contentForm').reset();
    document.getElementById('contentId').value = '';
    new bootstrap.Modal(document.getElementById('contentModal')).show();
}

function editContent(contentId) {
    fetch(`/api/cms/content/${contentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const content = data.content_block;
                document.getElementById('contentModalTitle').textContent = 'Edit Content Block';
                document.getElementById('contentId').value = content.id;
                document.getElementById('identifier').value = content.identifier;
                document.getElementById('title').value = content.title;
                document.getElementById('category').value = content.category || '';
                document.getElementById('section').value = content.section || '';
                document.getElementById('contentType').value = content.content_type;
                document.getElementById('content').value = content.content || '';
                document.getElementById('sortOrder').value = content.sort_order;
                document.getElementById('isActive').checked = content.is_active;
                
                new bootstrap.Modal(document.getElementById('contentModal')).show();
            }
        })
        .catch(error => {
            console.error('Error loading content:', error);
        });
}

function saveContent() {
    const contentId = document.getElementById('contentId').value;
    const formData = {
        identifier: document.getElementById('identifier').value,
        title: document.getElementById('title').value,
        category: document.getElementById('category').value,
        section: document.getElementById('section').value,
        content_type: document.getElementById('contentType').value,
        content: document.getElementById('content').value,
        sort_order: parseInt(document.getElementById('sortOrder').value),
        is_active: document.getElementById('isActive').checked
    };
    
    const url = contentId ? `/api/cms/content/${contentId}` : '/api/cms/content';
    const method = contentId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('contentModal')).hide();
            loadContentBlocks(currentCategory);
        } else {
            alert('Error saving content: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving content:', error);
        alert('Error saving content');
    });
}

function deleteContent(contentId) {
    if (confirm('Are you sure you want to delete this content block?')) {
        fetch(`/api/cms/content/${contentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadContentBlocks(currentCategory);
            } else {
                alert('Error deleting content: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting content:', error);
        });
    }
}
</script>
{% endblock %}