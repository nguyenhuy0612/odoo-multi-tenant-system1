{% extends "base.html" %} {% block title %}Billing Overview - Khudroo{% endblock
%} {% block extra_css %}
<style>
  /* Beautiful Billing Overview Styles */
  .billing-overview-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 20px 20px;
  }

  .summary-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    overflow: hidden;
  }

  .summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }

  .summary-card .card-body {
    padding: 2rem;
  }

  .summary-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .summary-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .tenant-billing-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
  }

  .tenant-billing-card:hover {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
  }

  .tenant-status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.8rem;
  }

  .billing-progress {
    height: 8px;
    border-radius: 10px;
    overflow: hidden;
    background: #e9ecef;
  }

  .billing-progress .progress-bar {
    border-radius: 10px;
    transition: all 0.5s ease;
  }

  .transaction-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    margin-bottom: 1rem;
    transition: all 0.2s ease;
  }

  .transaction-card:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .transaction-status {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .transaction-amount {
    font-size: 1.2rem;
    font-weight: 700;
  }

  .section-header {
    background: linear-gradient(
      135deg,
      var(--bg-secondary) 0%,
      var(--bg-tertiary) 100%
    );
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--border-primary);
  }

  .filter-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .billing-chart-container {
    position: relative;
    height: 300px;
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .summary-value {
      font-size: 2rem;
    }

    .billing-overview-header {
      padding: 1.5rem 0;
    }
  }
</style>
{% endblock %} {% block content %}
<!-- Billing Overview Header -->
<div class="billing-overview-header">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="mb-0">
          <i class="fas fa-file-invoice-dollar me-3"></i>Billing Overview
        </h1>
        <p class="mb-0 opacity-75">
          Complete billing status and transaction history for all your panels
        </p>
      </div>
      <div class="col-md-4 text-end">
        <div class="d-flex gap-2 justify-content-end">
          <button class="btn btn-light" onclick="window.print()">
            <i class="fas fa-print me-2"></i>Print Report
          </button>
          <button class="btn btn-success" onclick="exportToPDF()">
            <i class="fas fa-file-pdf me-2"></i>Export PDF
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <!-- Billing Summary Cards -->
  <div class="row g-4 mb-5">
    <div class="col-lg-3 col-md-6">
      <div class="summary-card h-100">
        <div class="card-body text-center">
          <div
            class="summary-icon bg-primary bg-opacity-10 text-primary mx-auto"
          >
            <i class="fas fa-server"></i>
          </div>
          <div class="summary-value text-primary">
            {{ billing_summary.total_tenants }}
          </div>
          <h6 class="text-muted mb-0">Total Panels</h6>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="summary-card h-100">
        <div class="card-body text-center">
          <div
            class="summary-icon bg-success bg-opacity-10 text-success mx-auto"
          >
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="summary-value text-success">
            {{ billing_summary.active_tenants }}
          </div>
          <h6 class="text-muted mb-0">Active Panels</h6>
        </div>
      </div>
    </div>

    {% if current_user.is_admin %}
    <div class="col-lg-3 col-md-6">
      <div class="summary-card h-100">
        <div class="card-body text-center">
          <div class="summary-icon bg-info bg-opacity-10 text-info mx-auto">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="summary-value text-info">
            ${{ "%.2f"|format(billing_summary.total_spent) }}
          </div>
          <h6 class="text-muted mb-0">Total Spent</h6>
        </div>
      </div>
    </div>
    {% else %}
    <div class="col-lg-3 col-md-6">
      <div class="summary-card h-100">
        <div class="card-body text-center">
          <div class="summary-icon bg-danger bg-opacity-10 text-danger mx-auto">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="summary-value text-danger">
            {{ billing_summary.inactive_tenants }}
          </div>
          <h6 class="text-muted mb-0">Inactive Panels</h6>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="col-lg-3 col-md-6">
      <div class="summary-card h-100">
        <div class="card-body text-center">
          <div
            class="summary-icon bg-warning bg-opacity-10 text-warning mx-auto"
          >
            <i class="fas fa-clock"></i>
          </div>
          <div class="summary-value text-warning">
            {{ billing_summary.pending_payments }}
          </div>
          <h6 class="text-muted mb-0">Pending Payments</h6>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-card">
    <div class="row align-items-center">
      <div class="col-md-6">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter & Search</h5>
      </div>
      <div class="col-md-6">
        <div class="row g-2">
          <div class="col-6">
            <select class="form-select" id="statusFilter">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="creating">Creating</option>
            </select>
          </div>
          <div class="col-6">
            <input
              type="text"
              class="form-control"
              id="searchInput"
              placeholder="Search panels..."
            />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Panel Billing Status Section -->
    <div class="col-lg-8">
      <div class="section-header">
        <h4 class="mb-0">
          <i class="fas fa-server me-2"></i>Panel Billing Status
        </h4>
        <small class="text-muted"
          >Real-time billing information for all your panels</small
        >
      </div>

      <div id="panelBillingContainer">
        {% for tenant in tenants %}
        <div
          class="tenant-billing-card"
          data-tenant-id="{{ tenant.id }}"
          data-status="{{ tenant.status }}"
        >
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-6">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <div
                      class="p-2 rounded-circle"
                      style="background: {% if tenant.is_active %}rgba(40, 167, 69, 0.1){% else %}rgba(220, 53, 69, 0.1){% endif %};"
                    >
                      <i
                        class="fas {% if tenant.is_active %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %}"
                      ></i>
                    </div>
                  </div>
                  <div>
                    <h6 class="mb-1 fw-bold">{{ tenant.name }}</h6>
                    <small class="text-muted"
                      >{{ tenant.subdomain }}.domain.com</small
                    >
                  </div>
                </div>
              </div>

              <div class="col-md-3">
                <div class="text-center">
                  <span
                    class="tenant-status-badge bg-{% if tenant.is_active %}success{% else %}danger{% endif %} text-white"
                  >
                    {% if tenant.is_active %}Active{% else %}Inactive{% endif %}
                  </span>
                  <div class="small text-muted mt-1">
                    {{ tenant.plan.title() }} Plan
                  </div>
                </div>
              </div>

              <div class="col-md-3">
                <div class="billing-info" data-tenant-id="{{ tenant.id }}">
                  <div class="text-center">
                    <div
                      class="billing-progress mb-2"
                      title="Billing cycle usage"
                    >
                      <div
                        class="progress-bar bg-secondary"
                        style="width: 0%"
                      ></div>
                    </div>
                    <small class="text-muted billing-status-text">
                      <i class="fas fa-spinner fa-spin"></i> Loading...
                    </small>
                    <div class="mt-1">
                      <small class="text-muted billing-hours-text"></small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <div class="row g-2">
                <div class="col-6">
                  <a
                    href="{{ url_for('manage_tenant', tenant_id=tenant.id) }}"
                    class="btn btn-outline-primary btn-sm w-100"
                  >
                    <i class="fas fa-cog me-1"></i>Manage
                  </a>
                </div>
                <div class="col-6">
                  {% if not tenant.is_active %}
                  <a
                    href="{{ url_for('billing.initiate_payment', tenant_id=tenant.id) }}"
                    class="btn btn-warning btn-sm w-100"
                  >
                    <i class="fas fa-credit-card me-1"></i>Pay to Renew
                  </a>
                  {% else %}
                  <a
                    href="https://kdoo_{{ tenant.subdomain }}.domain.com"
                    target="_blank"
                    class="btn btn-success btn-sm w-100"
                  >
                    <i class="fas fa-external-link-alt me-1"></i>Open Panel
                  </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Transaction History Section -->
    <div class="col-lg-4">
      <div class="section-header">
        <h4 class="mb-0">
          <i class="fas fa-receipt me-2"></i>Recent Transactions
        </h4>
        <small class="text-muted">Latest payment activity</small>
      </div>

      <div style="max-height: 600px; overflow-y: auto" id="transactionsList">
        {% for transaction in transactions %}
        <div class="transaction-card">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="mb-1">
                  {{ transaction.get_tenant_name() if
                  transaction.get_tenant_name else 'N/A' }} {% if
                  current_user.is_admin and transaction.user %}
                  <small class="text-muted"
                    >by {{ transaction.user.name }}</small
                  >
                  {% endif %}
                </h6>
                <small class="text-muted" title="Transaction ID">
                  <i class="fas fa-hashtag"></i> {{ transaction.transaction_id
                  }}
                </small>
                {% if transaction.gateway_transaction_id %}
                <br /><small class="text-muted" title="Gateway Transaction ID">
                  <i class="fas fa-external-link-alt"></i> {{
                  transaction.gateway_transaction_id }}
                </small>
                {% endif %}
              </div>
              <div class="text-end">
                <div
                  class="transaction-amount text-{% if transaction.status == 'VALIDATED' %}success{% elif transaction.status == 'PENDING' %}warning{% else %}danger{% endif %}"
                >
                  ${{ "%.2f"|format(transaction.amount) }}
                </div>
                <small class="text-muted"
                  >{{ transaction.currency or 'USD' }}</small
                >
                {% if transaction.payment_method %}
                <br /><small class="text-muted">
                  <i class="fas fa-credit-card"></i> {{
                  transaction.payment_method.title() }}
                </small>
                {% endif %}
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-2">
                <span
                  class="transaction-status bg-{% if transaction.status == 'VALIDATED' %}success{% elif transaction.status == 'PENDING' %}warning{% else %}danger{% endif %} text-white"
                >
                  {% if transaction.status == 'VALIDATED' %}
                  <i class="fas fa-check"></i> Validated {% elif
                  transaction.status == 'PENDING' %}
                  <i class="fas fa-clock"></i> Pending {% elif
                  transaction.status == 'FAILED' %}
                  <i class="fas fa-times"></i> Failed {% else %} {{
                  transaction.status }} {% endif %}
                </span>
                {% if transaction.notes %}
                <small class="text-muted" title="{{ transaction.notes }}">
                  <i class="fas fa-sticky-note"></i>
                </small>
                {% endif %}
              </div>
              <div class="text-end">
                <small class="text-muted">
                  {{ transaction.created_at.strftime('%b %d, %Y at %I:%M %p') if
                  transaction.created_at else 'N/A' }}
                </small>
                {% if transaction.validated_at and transaction.status ==
                'VALIDATED' %}
                <br /><small class="text-success">
                  <i class="fas fa-check-circle"></i> {{
                  transaction.validated_at.strftime('%b %d, %Y') }}
                </small>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %} {% if not transactions %}
        <div class="text-center py-5">
          <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
          <h6 class="text-muted">No transactions yet</h6>
          <p class="text-muted">Your payment history will appear here</p>
          {% if not current_user.is_admin %}
          <a
            href="{{ url_for('main.dashboard') }}"
            class="btn btn-primary btn-sm mt-2"
          >
            <i class="fas fa-plus"></i> Create your first panel
          </a>
          {% endif %}
        </div>
        {% endif %}
      </div>

      {% if transactions|length >= 50 %}
      <div class="text-center mt-3">
        <small class="text-muted">
          <i class="fas fa-info-circle"></i> Showing latest 50 transactions {%
          if current_user.is_admin %} <br /><a
            href="{{ url_for('billing.admin_billing_logs') }}"
            class="btn btn-link btn-sm p-0"
            >View all billing logs</a
          >
          {% endif %}
        </small>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Load billing information for all panels on page load
  document.addEventListener("DOMContentLoaded", function () {
    loadAllBillingInfo();

    // Set up filters
    setupFilters();

    // Set up real-time notifications
    setupNotifications();

    // Auto-refresh every 60 seconds
    setInterval(loadAllBillingInfo, 60000);

    // Check for urgent billing notifications every 30 seconds
    setInterval(checkBillingNotifications, 30000);
  });

  // Function to load billing info for all panels
  function loadAllBillingInfo() {
    const billingInfoElements = document.querySelectorAll(
      ".billing-info[data-tenant-id]"
    );

    billingInfoElements.forEach((element) => {
      const tenantId = element.dataset.tenantId;
      loadPanelBillingInfo(tenantId, element);
    });
  }

  // Function to load billing info for a specific panel
  function loadPanelBillingInfo(tenantId, element) {
    fetch(`/billing/panel/${tenantId}/info`)
      .then((response) => response.json())
      .then((data) => {
        updatePanelBillingDisplay(element, data);
      })
      .catch((error) => {
        console.error("Error loading billing info for tenant", tenantId, error);
        element.querySelector(".billing-status-text").textContent =
          "Error loading";
      });
  }

  // Function to update panel billing display
  function updatePanelBillingDisplay(element, data) {
    const progressBar = element.querySelector(".progress-bar");
    const statusText = element.querySelector(".billing-status-text");

    if (data.error) {
      progressBar.style.width = "0%";
      progressBar.className = "progress-bar bg-secondary";
      statusText.textContent = "No billing data";
      return;
    }

    // Check if billing cycle exists and is expired
    if (!data.current_cycle || data.current_cycle.is_expired) {
      progressBar.style.width = "100%";
      progressBar.className = "progress-bar bg-danger";
      statusText.textContent = "Billing Expired";
      return;
    }

    const cycle = data.current_cycle;
    const hoursUsed = cycle.hours_used || 0;
    const hoursAllowed = cycle.total_hours_allowed || 360;
    const hoursRemaining = cycle.hours_remaining || 0;

    // Calculate usage percentage
    const usagePercent = Math.min((hoursUsed / hoursAllowed) * 100, 100);

    // Calculate days remaining based on hours remaining and current usage rate
    const daysRemaining =
      cycle.days_remaining || Math.ceil(hoursRemaining / 12);

    progressBar.style.width = usagePercent + "%";

    // Set progress bar color based on usage
    if (usagePercent >= 90 || daysRemaining <= 2) {
      progressBar.className = "progress-bar bg-danger";
      statusText.textContent =
        daysRemaining <= 0
          ? "Expired"
          : `${daysRemaining} day${daysRemaining !== 1 ? "s" : ""} left`;
    } else if (usagePercent >= 75 || daysRemaining <= 7) {
      progressBar.className = "progress-bar bg-warning";
      statusText.textContent = `${daysRemaining} day${
        daysRemaining !== 1 ? "s" : ""
      } left`;
    } else {
      progressBar.className = "progress-bar bg-success";
      statusText.textContent = `${daysRemaining} day${
        daysRemaining !== 1 ? "s" : ""
      } left`;
    }

    // Add usage info to hours text element
    const hoursText = element.querySelector(".billing-hours-text");
    if (hoursText) {
      hoursText.textContent = `${hoursUsed.toFixed(1)}h / ${hoursAllowed}h`;
    }

    // Add usage info tooltip
    const usageInfo = `${hoursUsed.toFixed(1)}h / ${hoursAllowed}h used`;
    element.title = usageInfo;
  }

  // Function to setup filters
  function setupFilters() {
    const statusFilter = document.getElementById("statusFilter");
    const searchInput = document.getElementById("searchInput");

    statusFilter.addEventListener("change", filterPanels);
    searchInput.addEventListener("input", filterPanels);
  }

  // Function to filter panels
  function filterPanels() {
    const statusFilter = document.getElementById("statusFilter").value;
    const searchTerm = document
      .getElementById("searchInput")
      .value.toLowerCase();
    const panelCards = document.querySelectorAll(".tenant-billing-card");

    panelCards.forEach((card) => {
      const cardStatus = card.dataset.status;
      const cardText = card.textContent.toLowerCase();

      const matchesStatus = !statusFilter || cardStatus === statusFilter;
      const matchesSearch = !searchTerm || cardText.includes(searchTerm);

      if (matchesStatus && matchesSearch) {
        card.style.display = "block";
        card.style.animation = "fadeInUp 0.3s ease";
      } else {
        card.style.display = "none";
      }
    });
  }

  // Function to setup notifications
  function setupNotifications() {
    // Create notification container if it doesn't exist
    if (!document.getElementById("billingNotifications")) {
      const notificationContainer = document.createElement("div");
      notificationContainer.id = "billingNotifications";
      notificationContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
      document.body.appendChild(notificationContainer);
    }
  }

  // Function to check for billing notifications
  function checkBillingNotifications() {
    // Get all tenant IDs
    const tenantElements = document.querySelectorAll(
      ".billing-info[data-tenant-id]"
    );

    tenantElements.forEach((element) => {
      const tenantId = element.dataset.tenantId;

      fetch(`/billing/notifications/${tenantId}`)
        .then((response) => response.json())
        .then((data) => {
          if (data.notifications && data.notifications.length > 0) {
            data.notifications.forEach((notification) => {
              showBillingNotification(notification);
            });
          }
        })
        .catch((error) => {
          console.error("Error checking notifications:", error);
        });
    });
  }

  // Function to show billing notification
  function showBillingNotification(notification) {
    const container = document.getElementById("billingNotifications");
    if (!container) return;

    const notificationElement = document.createElement("div");
    notificationElement.className = `alert alert-${getNotificationClass(
      notification.type
    )} alert-dismissible fade show`;
    notificationElement.innerHTML = `
        <div class="d-flex align-items-start">
            <i class="fas ${getNotificationIcon(
              notification.type
            )} me-2 mt-1"></i>
            <div class="flex-grow-1">
                <strong>${notification.type
                  .replace("_", " ")
                  .toUpperCase()}</strong>
                <div>${notification.message}</div>
                <small class="text-muted">${new Date(
                  notification.sent_at
                ).toLocaleString()}</small>
            </div>
            <button type="button" class="btn-close" onclick="dismissNotification(${
              notification.id
            }, this)"></button>
        </div>
    `;

    container.appendChild(notificationElement);

    // Auto-dismiss after 10 seconds for non-critical notifications
    if (notification.type !== "expiry") {
      setTimeout(() => {
        dismissNotification(
          notification.id,
          notificationElement.querySelector(".btn-close")
        );
      }, 10000);
    }
  }

  // Function to get notification CSS class
  function getNotificationClass(type) {
    switch (type) {
      case "reminder":
        return "warning";
      case "expiry":
        return "danger";
      case "renewal":
        return "success";
      default:
        return "info";
    }
  }

  // Function to get notification icon
  function getNotificationIcon(type) {
    switch (type) {
      case "reminder":
        return "fa-exclamation-triangle";
      case "expiry":
        return "fa-times-circle";
      case "renewal":
        return "fa-check-circle";
      default:
        return "fa-info-circle";
    }
  }

  // Function to dismiss notification
  function dismissNotification(notificationId, element) {
    // Mark as read on server
    fetch(`/billing/notifications/${notificationId}/read`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    });

    // Remove from DOM
    const notification = element.closest(".alert");
    if (notification) {
      notification.remove();
    }
  }

  // Function to export to PDF (placeholder)
  function exportToPDF() {
    // Show loading state
    const exportBtn = event.target;
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML =
      '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    exportBtn.disabled = true;

    // Simulate PDF generation
    setTimeout(() => {
      exportBtn.innerHTML = originalText;
      exportBtn.disabled = false;
      alert("PDF export functionality will be implemented soon!");
    }, 2000);
  }

  // CSS animation keyframes
  const style = document.createElement("style");
  style.textContent = `
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
`;
  document.head.appendChild(style);
</script>
{% endblock %}
