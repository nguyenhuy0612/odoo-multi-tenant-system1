{% extends "base.html" %} {% block title %}System Admin Dashboard - Khudroo{% endblock %} {% block content %}
<!-- Enhanced Dashboard Container -->
<div class="dashboard-container">
  <!-- Welcome Section with Modern Design -->
  <div class="system-header mb-4">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="mb-2">
          <i class="fas fa-tools me-3 float-animation"></i>
          System Administration
        </h1>
        <p class="mb-0 fs-5">
          Monitor and manage your Khudroo infrastructure with advanced
          controls.
          <span class="badge bg-success ms-2 pulse-animation">
            <i class="fas fa-circle me-1"></i>
            All Systems Online
          </span>
        </p>
      </div>
      <div class="col-lg-4 text-lg-end">
        <div class="d-flex flex-column align-items-lg-end gap-2">
          <div class="d-flex align-items-center gap-3">
            <div class="text-white-50 small">
              <i class="fas fa-clock me-1"></i>
              Last check:
              <span id="lastCheck"
                >{{ moment().format('MMM DD, YYYY HH:mm') }}</span
              >
            </div>
          </div>
          <div class="d-flex gap-2">
            <button
              class="btn btn-outline-light btn-action"
              data-bs-toggle="modal"
              data-bs-target="#maintenanceModal"
            >
              <i class="fas fa-wrench me-2"></i>
              Maintenance Mode
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- System Overview Stats -->
  <div class="system-status-grid">
    <div class="metric-card text-center">
      <div class="d-flex align-items-center justify-content-between">
        <div class="text-start">
          <div class="metric-value text-primary" id="systemCpuUsage">--</div>
          <div class="metric-label">CPU Usage</div>
          <small class="text-muted">
            <i class="fas fa-microchip me-1"></i>
            System load
          </small>
        </div>
        <div class="ms-3">
          <div
            class="circular-progress bg-primary bg-opacity-10 d-flex align-items-center justify-content-center"
            style="width: 80px; height: 80px; border-radius: 50%"
          >
            <i class="fas fa-microchip fa-2x text-primary"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="metric-card text-center">
      <div class="d-flex align-items-center justify-content-between">
        <div class="text-start">
          <div class="metric-value text-info" id="systemMemoryUsage">--</div>
          <div class="metric-label">Memory Usage</div>
          <small class="text-muted">
            <i class="fas fa-memory me-1"></i>
            RAM utilization
          </small>
        </div>
        <div class="ms-3">
          <div
            class="circular-progress bg-info bg-opacity-10 d-flex align-items-center justify-content-center"
            style="width: 80px; height: 80px; border-radius: 50%"
          >
            <i class="fas fa-memory fa-2x text-info"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="metric-card text-center">
      <div class="d-flex align-items-center justify-content-between">
        <div class="text-start">
          <div class="metric-value text-warning" id="systemDiskUsage">--</div>
          <div class="metric-label">Disk Usage</div>
          <small class="text-muted">
            <i class="fas fa-hdd me-1"></i>
            Storage space
          </small>
        </div>
        <div class="ms-3">
          <div
            class="circular-progress bg-warning bg-opacity-10 d-flex align-items-center justify-content-center"
            style="width: 80px; height: 80px; border-radius: 50%"
          >
            <i class="fas fa-hdd fa-2x text-warning"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="metric-card text-center">
      <div class="d-flex align-items-center justify-content-between">
        <div class="text-start">
          <div class="metric-value text-success" id="activeWorkers">--</div>
          <div class="metric-label">Active Workers</div>
          <small class="text-muted">
            <i class="fas fa-server me-1"></i>
            Running containers
          </small>
        </div>
        <div class="ms-3">
          <div
            class="circular-progress bg-success bg-opacity-10 d-flex align-items-center justify-content-center"
            style="width: 80px; height: 80px; border-radius: 50%"
          >
            <i class="fas fa-server fa-2x text-success"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Navigation Tabs -->
<ul class="nav nav-pills justify-content-center mb-4" id="mainTabs">
  <li class="nav-item">
    <a class="nav-link" href="/system-admin/workers">
      <i class="fas fa-cogs me-2"></i>Worker Management
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link active" data-bs-toggle="pill" href="#redis">
      <i class="fas fa-database me-2"></i>Redis
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-bs-toggle="pill" href="#postgres">
      <i class="fas fa-server me-2"></i>PostgreSQL
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-bs-toggle="pill" href="#nginx">
      <i class="fas fa-globe me-2"></i>Nginx
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-bs-toggle="pill" href="#vps-servers">
      <i class="fas fa-cloud me-2"></i>VPS Servers
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-bs-toggle="pill" href="#monitoring">
      <i class="fas fa-chart-line me-2"></i>Monitoring
    </a>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
  <!-- Redis Tab -->
  <div class="tab-pane fade show active" id="redis">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="mb-1">
          <i class="fas fa-database me-2 text-primary"></i>
          Redis Management
        </h3>
        <p class="text-muted mb-0">Cache server monitoring and control</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-info btn-action" onclick="refreshRedisInfo()">
          <i class="fas fa-sync-alt me-2"></i>
          Refresh
        </button>
        <button class="btn btn-danger btn-action" onclick="flushRedis()">
          <i class="fas fa-trash me-2"></i>
          Flush All
        </button>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-info-circle me-2"></i>
              Server Information
            </h5>
          </div>
          <div class="card-body">
            <div id="redisInfo">
              <div class="text-center py-3">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted">Loading Redis info...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-memory me-2"></i>
              Memory Usage
            </h5>
          </div>
          <div class="card-body">
            <div id="redisMemory">
              <div class="text-center py-3">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted">Loading memory info...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-warning text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-key me-2"></i>
            Redis Keys
          </h5>
          <button
            class="btn btn-sm btn-outline-light"
            onclick="searchRedisKeys()"
          >
            <i class="fas fa-search me-2"></i>
            Search Keys
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              id="redisKeyPattern"
              placeholder="Search pattern (e.g., user:*, cache:*)"
              value="*"
            />
            <button
              class="btn btn-primary"
              type="button"
              onclick="searchRedisKeys()"
            >
              Search
            </button>
          </div>
        </div>
        <div id="redisKeys" class="code-block" style="min-height: 200px">
          Click "Search Keys" to view Redis keys
        </div>
      </div>
    </div>
  </div>

  <!-- PostgreSQL Tab -->
  <div class="tab-pane fade" id="postgres">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="mb-1">
          <i class="fas fa-server me-2 text-primary"></i>
          PostgreSQL Management
        </h3>
        <p class="text-muted mb-0">Database server monitoring and queries</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-info btn-action" onclick="refreshPostgresInfo()">
          <i class="fas fa-sync-alt me-2"></i>
          Refresh
        </button>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h6 class="card-title mb-0">
              <i class="fas fa-database me-2"></i>
              Databases
            </h6>
          </div>
          <div class="card-body">
            <div id="postgresDatabases">
              <div class="text-center py-3">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted small">Loading...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h6 class="card-title mb-0">
              <i class="fas fa-plug me-2"></i>
              Connections
            </h6>
          </div>
          <div class="card-body">
            <div id="postgresConnections">
              <div class="text-center py-3">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted small">Loading...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h6 class="card-title mb-0">
              <i class="fas fa-table me-2"></i>
              Table Sizes
            </h6>
          </div>
          <div class="card-body">
            <div id="postgresTables">
              <div class="text-center py-3">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted small">Loading...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-secondary text-white">
        <h5 class="card-title mb-0">
          <i class="fas fa-terminal me-2"></i>
          Query Console
        </h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">SQL Query (SELECT statements only)</label>
          <textarea
            class="form-control"
            id="postgresQuery"
            rows="4"
            placeholder="Enter SELECT query..."
            style="font-family: 'Courier New', monospace"
          >
SELECT * FROM tenants LIMIT 10;</textarea
          >
        </div>
        <button
          class="btn btn-primary btn-action"
          onclick="executePostgresQuery()"
        >
          <i class="fas fa-play me-2"></i>
          Execute Query
        </button>
        <div id="postgresQueryResult" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- Nginx Tab -->
  <div class="tab-pane fade" id="nginx">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="mb-1">
          <i class="fas fa-globe me-2 text-primary"></i>
          Nginx Management
        </h3>
        <p class="text-muted mb-0">Web server and load balancer control</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-warning btn-action" onclick="reloadNginx()">
          <i class="fas fa-sync me-2"></i>
          Reload Config
        </button>
        <button class="btn btn-info btn-action" onclick="refreshNginxStatus()">
          <i class="fas fa-refresh me-2"></i>
          Refresh Status
        </button>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-heartbeat me-2"></i>
              Nginx Status
            </h5>
          </div>
          <div class="card-body">
            <div id="nginxStatus">
              <div class="text-center py-3">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted">Loading Nginx status...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-warning text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-tools me-2"></i>
              Quick Actions
            </h5>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button
                class="btn btn-warning btn-action"
                onclick="reloadNginx()"
              >
                <i class="fas fa-sync me-2"></i>
                Reload Configuration
              </button>
              <button
                class="btn btn-info btn-action"
                onclick="refreshNginxStatus()"
              >
                <i class="fas fa-refresh me-2"></i>
                Refresh Status
              </button>
              <button
                class="btn btn-secondary btn-action"
                onclick="viewNginxConfig()"
              >
                <i class="fas fa-file-code me-2"></i>
                View Configuration
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-dark text-white">
        <h5 class="card-title mb-0">
          <i class="fas fa-file-alt me-2"></i>
          Recent Logs
        </h5>
      </div>
      <div class="card-body p-0">
        <div
          id="nginxLogs"
          class="log-container"
          style="max-height: 300px; margin: 0; border-radius: 0 0 12px 12px"
        >
          Loading Nginx logs...
        </div>
      </div>
    </div>
  </div>

  <!-- Monitoring Tab -->
  <div class="tab-pane fade" id="monitoring">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="mb-1">
          <i class="fas fa-chart-line me-2 text-primary"></i>
          System Monitoring
        </h3>
        <p class="text-muted mb-0">
          Real-time system performance and resource usage
        </p>
      </div>
      <div class="d-flex gap-2">
        <button
          class="btn btn-info btn-action"
          onclick="refreshMonitoringData()"
        >
          <i class="fas fa-sync-alt me-2"></i>
          Refresh
        </button>
        <button class="btn btn-secondary btn-action" onclick="exportMetrics()">
          <i class="fas fa-download me-2"></i>
          Export Metrics
        </button>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-chart-area me-2"></i>
              Resource Usage
            </h5>
          </div>
          <div class="card-body">
            <div id="resourceMonitoring">
              <div class="text-center py-4">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted">Loading resource data...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-server me-2"></i>
              Container Resources
            </h5>
          </div>
          <div class="card-body">
            <div id="topProcesses">
              <div class="text-center py-4">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted">Loading processes...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">
          <i class="fas fa-balance-scale me-2"></i>
          Load Balancing Status
        </h5>
      </div>
      <div class="card-body">
        <div id="loadBalancingStatus">
          <div class="text-center py-4">
            <div class="loading-spinner"></div>
            <p class="mt-2 text-muted">Loading load balancing status...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- VPS Servers Tab -->
  <div class="tab-pane fade" id="vps-servers">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="mb-1">
          <i class="fas fa-cloud me-2 text-primary"></i>
          VPS Server Management
        </h3>
        <p class="text-muted mb-0">
          Monitor and manage remote VPS servers from infrastructure admin
        </p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-info btn-action" onclick="refreshVPSServers()">
          <i class="fas fa-sync-alt me-2"></i>
          Refresh
        </button>
        <button class="btn btn-warning btn-action" onclick="healthCheckAllVPS()">
          <i class="fas fa-heartbeat me-2"></i>
          Health Check All
        </button>
      </div>
    </div>

    <!-- VPS Summary Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="metric-card text-center">
          <div class="metric-value" id="totalVPSServers">0</div>
          <div class="metric-label">Total Servers</div>
          <i class="fas fa-server metric-icon text-primary"></i>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card text-center">
          <div class="metric-value" id="onlineVPSServers">0</div>
          <div class="metric-label">Online</div>
          <i class="fas fa-check-circle metric-icon text-success"></i>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card text-center">
          <div class="metric-value" id="workerCapableVPS">0</div>
          <div class="metric-label">Worker Capable</div>
          <i class="fas fa-cogs metric-icon text-info"></i>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card text-center">
          <div class="metric-value" id="vpsWithWorkers">0</div>
          <div class="metric-label">With Workers</div>
          <i class="fas fa-play-circle metric-icon text-warning"></i>
        </div>
      </div>
    </div>

    <!-- VPS Servers Table -->
    <div class="card">
      <div class="card-header bg-gradient-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>
            VPS Servers List
          </h5>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-light" onclick="filterVPSServers('all')">
              <i class="fas fa-list me-1"></i>All
            </button>
            <button class="btn btn-sm btn-outline-light" onclick="filterVPSServers('active')">
              <i class="fas fa-circle me-1 text-success"></i>Active
            </button>
            <button class="btn btn-sm btn-outline-light" onclick="filterVPSServers('offline')">
              <i class="fas fa-times-circle me-1 text-danger"></i>Offline
            </button>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
              <tr>
                <th style="width: 15%">Server Name</th>
                <th style="width: 12%">IP Address</th>
                <th style="width: 10%">Status</th>
                <th style="width: 8%">Health</th>
                <th style="width: 15%">Specs</th>
                <th style="width: 15%">Services</th>
                <th style="width: 10%">Workers</th>
                <th style="width: 15%">Actions</th>
              </tr>
            </thead>
            <tbody id="vpsServersTableBody">
              <tr>
                <td colspan="8" class="text-center py-4">
                  <div class="loading-spinner"></div>
                  <p class="mt-2 text-muted">Loading VPS servers...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- VPS Server Details Modal -->
    <div class="modal fade" id="vpsServerModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-server me-2"></i>
              VPS Server Details
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="vpsServerDetails">
              <div class="text-center py-4">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted">Loading server details...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-info" onclick="testVPSConnection()">
              <i class="fas fa-plug me-2"></i>Test Connection
            </button>
            <button type="button" class="btn btn-primary" onclick="showVPSWorkers()">
              <i class="fas fa-cogs me-2"></i>View Workers
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Command Execution Modal -->
    <div class="modal fade" id="vpsCommandModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title">
              <i class="fas fa-terminal me-2"></i>
              Execute Command on VPS
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="vpsCommand" class="form-label">Command</label>
              <div class="input-group">
                <span class="input-group-text bg-dark text-white">$</span>
                <input type="text" class="form-control" id="vpsCommand" placeholder="Enter command (e.g., ls -la, ps aux, docker ps)">
                <button class="btn btn-primary" onclick="executeVPSCommand()">
                  <i class="fas fa-play me-2"></i>Execute
                </button>
              </div>
              <div class="form-text">Only safe commands are allowed. Dangerous operations are blocked.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Output</label>
              <div id="vpsCommandOutput" class="border rounded p-3 bg-dark text-light" style="min-height: 200px; font-family: monospace;">
                <div class="text-muted">Command output will appear here...</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-warning" onclick="clearCommandOutput()">
              <i class="fas fa-eraser me-2"></i>Clear
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Create Worker Modal -->
<div class="modal fade" id="createWorkerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-plus me-2"></i>
          Create New Odoo Worker
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="createWorkerForm">
          <div class="mb-3">
            <label class="form-label">Target Server</label>
            <select class="form-control" name="server_id" id="targetServerSelect" required>
              <option value="">Select a server...</option>
            </select>
            <small class="form-text text-muted">Choose which server to deploy the Odoo worker on</small>
            <div id="serverStatusIndicator" class="mt-2" style="display: none;">
              <span class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>Server is online
              </span>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Worker Name</label>
            <input
              type="text"
              class="form-control"
              name="name"
              placeholder="odoo_worker_custom_01"
              value="odoo_worker_"
              required
            />
            <small class="form-text text-muted"
              >Format: odoo_worker_[name] (e.g., odoo_worker_production,
              odoo_worker_backup)</small
            >
          </div>
          <div class="mb-3">
            <label class="form-label">Port (Internal)</label>
            <input
              type="number"
              class="form-control"
              name="port"
              value="8069"
              readonly
            />
            <small class="form-text text-muted"
              >Odoo default port (internal container port)</small
            >
          </div>
          <div class="mb-3">
            <label class="form-label">Max Tenants</label>
            <select class="form-control" name="max_tenants" required>
              <option value="5">5 tenants (Light load)</option>
              <option value="10" selected>10 tenants (Standard)</option>
              <option value="15">15 tenants (Medium load)</option>
              <option value="20">20 tenants (Heavy load)</option>
              <option value="25">25 tenants (Maximum)</option>
            </select>
            <small class="form-text text-muted"
              >Recommended: 10-15 tenants per worker for optimal
              performance</small
            >
          </div>
          <div class="mb-3">
            <label class="form-label">Worker Type</label>
            <select
              class="form-control"
              name="worker_type"
              onchange="updateWorkerSettings()"
            >
              <option value="standard" selected>Standard Worker</option>
              <option value="high_performance">High Performance</option>
              <option value="backup">Backup/Failover</option>
              <option value="development">Development</option>
            </select>
          </div>
          
          <!-- PostgreSQL Configuration Section -->
          <div class="card mt-3 mb-3">
            <div class="card-header">
              <h6 class="mb-0"><i class="fas fa-database me-2"></i>PostgreSQL Configuration</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <label class="form-label">PostgreSQL Host/IP</label>
                  <input
                    type="text"
                    class="form-control"
                    name="postgres_host"
                    placeholder="192.168.50.152"
                    value="192.168.50.152"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Port</label>
                  <input
                    type="number"
                    class="form-control"
                    name="postgres_port"
                    placeholder="5432"
                    value="5432"
                    required
                  />
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-6">
                  <label class="form-label">Database Name</label>
                  <input
                    type="text"
                    class="form-control"
                    name="postgres_database"
                    placeholder="postgres"
                    value="postgres"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Username</label>
                  <input
                    type="text"
                    class="form-control"
                    name="postgres_user"
                    placeholder="odoo_master"
                    value="odoo_master"
                    required
                  />
                </div>
              </div>
              <div class="mt-3">
                <label class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  name="postgres_password"
                  placeholder="secure_password_123"
                  value="secure_password_123"
                  required
                />
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="submitCreateWorker()"
        >
          <i class="fas fa-plus me-2"></i>Create Odoo Worker
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Maintenance Mode Modal -->
<div class="modal fade" id="maintenanceModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-wrench me-2"></i>
          Maintenance Mode
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> Enabling maintenance mode will temporarily
          disable user access to all tenants.
        </div>
        <p>
          Use maintenance mode when performing system updates or critical
          maintenance tasks.
        </p>
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="confirmMaintenance"
          />
          <label class="form-check-label" for="confirmMaintenance">
            I understand the impact of enabling maintenance mode
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-warning"
          onclick="toggleMaintenanceMode()"
          disabled
          id="maintenanceBtn"
        >
          <i class="fas fa-wrench me-2"></i>Enable Maintenance Mode
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  // System Admin Dashboard JavaScript
  document.addEventListener("DOMContentLoaded", function () {
    initializeSystemDashboard();
    setupTabEvents();
    setupAutoRefresh();
  });

  function initializeSystemDashboard() {
    console.log("Initializing System Dashboard...");
    
    // Load initial system resources
    loadSystemResources();

    // Load workers by default (first tab)
    loadWorkers();

    // Setup maintenance mode checkbox
    setupMaintenanceMode();

    // Update last check time
    updateLastCheckTime();
    
    console.log("System Dashboard initialized successfully");
  }

  function updateLastCheckTime() {
    const lastCheckElement = document.getElementById("lastCheck");
    if (lastCheckElement) {
      const now = new Date();
      lastCheckElement.textContent = now.toLocaleDateString("en-US", {
        month: "short",
        day: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }
  }

  function setupTabEvents() {
    document.querySelectorAll('[data-bs-toggle="pill"]').forEach((tab) => {
      tab.addEventListener("shown.bs.tab", function (e) {
        const target = e.target.getAttribute("href").substring(1);
        onTabChange(target);
      });
    });
  }

  function onTabChange(tabId) {
    switch (tabId) {
      case "redis":
        loadRedisInfo();
        break;
      case "postgres":
        loadPostgresInfo();
        break;
      case "nginx":
        loadNginxStatus();
        break;
      case "monitoring":
        loadMonitoringData();
        break;
    }
  }

  // System Resource Loading
  function loadSystemResources() {
    fetch("/system-admin/api/system/resources")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          updateSystemMetrics(data);
        }
      })
      .catch((error) => {
        console.error("Failed to load system resources:", error);
        showFallbackMetrics();
      });
  }

  function updateSystemMetrics(data) {
    document.getElementById("systemCpuUsage").textContent =
      data.cpu?.percent + "%" || "--";
    document.getElementById("systemMemoryUsage").textContent =
      data.memory?.percent + "%" || "--";
    document.getElementById("systemDiskUsage").textContent =
      data.disk?.percent + "%" || "--";
    document.getElementById("activeWorkers").textContent =
      data.active_workers || "--";
  }

  function showFallbackMetrics() {
    // Show placeholder data when API is not available
    document.getElementById("systemCpuUsage").textContent = "45%";
    document.getElementById("systemMemoryUsage").textContent = "62%";
    document.getElementById("systemDiskUsage").textContent = "78%";
    document.getElementById("activeWorkers").textContent = "3";
  }

  // Worker Management
  function loadWorkers() {
    console.log("Loading workers...");
    
    // Show loading state
    const container = document.getElementById("workersContainer");
    if (container) {
      container.innerHTML = `
        <div class="text-center py-5">
          <div class="loading-spinner"></div>
          <p class="mt-3 text-muted">Loading workers...</p>
        </div>
      `;
    }
    
    fetch("/system-admin/api/workers/list")
      .then((response) => {
        console.log("Workers API response status:", response.status);
        return response.json();
      })
      .then((data) => {
        console.log("Workers API response data:", data);
        if (data.success) {
          console.log("Found", data.workers.length, "workers");
          renderWorkers(data.workers);
        } else {
          console.error("Workers API returned error:", data.message);
          showWorkersError(data.message);
        }
      })
      .catch((error) => {
        console.error("Failed to load workers:", error);
        showWorkersError(error.message);
      });
  }

  function renderWorkers(workers) {
    const container = document.getElementById("workersContainer");

    if (!workers || workers.length === 0) {
      container.innerHTML = `
            <div class="text-center py-5">
                <div class="card border-0" style="background: var(--bg-secondary);">
                    <div class="card-body py-5">
                        <i class="fas fa-server fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted mb-2">No Workers Found</h5>
                        <p class="text-muted">Create your first worker to get started</p>
                        <button class="btn btn-primary btn-action" onclick="createWorker()">
                            <i class="fas fa-plus me-2"></i>Create Worker
                        </button>
                    </div>
                </div>
            </div>
        `;
      return;
    }

    const workersHtml = workers
      .map(
        (worker) => `
        <div class="card mb-3 worker-card ${worker.status}">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h6 class="mb-0">
                            <span class="status-indicator ${
                              worker.health_check
                                ? "status-healthy"
                                : "status-critical"
                            } me-2"></span>
                            ${worker.container_name}
                        </h6>
                        <small class="text-muted">ID: ${
                          worker.container_id || "N/A"
                        }</small>
                    </div>
                    <div class="col-md-4">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="metric-value text-primary" style="font-size: 1rem;">${
                                  worker.cpu_percent || 0
                                }%</div>
                                <div class="metric-label small">CPU</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-value text-info" style="font-size: 1rem;">${
                                  worker.memory_percent || 0
                                }%</div>
                                <div class="metric-label small">Memory</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-value text-success" style="font-size: 1rem;">${
                                  worker.db_current_tenants || 0
                                }/${worker.db_max_tenants || 0}</div>
                                <div class="metric-label small">Tenants</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-success" onclick="workerAction('${
                              worker.container_name
                            }', 'start')" 
                                    ${
                                      worker.status === "running"
                                        ? "disabled"
                                        : ""
                                    }>
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="workerAction('${
                              worker.container_name
                            }', 'restart')">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="workerAction('${
                              worker.container_name
                            }', 'stop')" 
                                    ${
                                      worker.status === "exited"
                                        ? "disabled"
                                        : ""
                                    }>
                                <i class="fas fa-stop"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="showWorkerLogs('${
                              worker.container_name
                            }')">
                                <i class="fas fa-file-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `
      )
      .join("");

    container.innerHTML = workersHtml;
  }

  function showWorkersError(errorMessage = "Unknown error") {
    document.getElementById("workersContainer").innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Failed to load workers: ${errorMessage}
            <br><small class="text-muted mt-2">Please check your connection and try again.</small>
            <button class="btn btn-sm btn-outline-danger ms-2" onclick="loadWorkers()">
                <i class="fas fa-sync-alt me-1"></i>Retry
            </button>
        </div>
    `;
  }

  function createWorker() {
    const modal = new bootstrap.Modal(
      document.getElementById("createWorkerModal")
    );
    
    // Load available servers when modal opens
    loadAvailableServers();
    modal.show();
  }

  async function loadAvailableServers() {
    try {
      const response = await fetch('/infra-admin/api/servers/available-workers');
      const result = await response.json();
      
      const select = document.getElementById('targetServerSelect');
      select.innerHTML = '<option value="">Select a server...</option>';
      
      if (result.success && result.servers) {
        result.servers.forEach(server => {
          const option = document.createElement('option');
          option.value = server.id;
          option.textContent = `${server.name} (${server.ip_address}) - ${server.status}`;
          option.dataset.serverIp = server.ip_address;
          option.dataset.serverStatus = server.status;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading servers:', error);
      showNotification('Failed to load available servers', 'error');
    }
  }

  // Add server status check when server is selected
  document.addEventListener('DOMContentLoaded', function() {
    const serverSelect = document.getElementById('targetServerSelect');
    if (serverSelect) {
      serverSelect.addEventListener('change', async function() {
        const serverStatusIndicator = document.getElementById('serverStatusIndicator');
        
        if (this.value) {
          const selectedOption = this.options[this.selectedIndex];
          const serverStatus = selectedOption.dataset.serverStatus;
          
          if (serverStatus === 'active') {
            serverStatusIndicator.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Server is online</span>';
            serverStatusIndicator.style.display = 'block';
          } else {
            serverStatusIndicator.innerHTML = '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>Server status: ' + serverStatus + '</span>';
            serverStatusIndicator.style.display = 'block';
          }
        } else {
          serverStatusIndicator.style.display = 'none';
        }
      });
    }
  });

  function submitCreateWorker() {
    const form = document.getElementById("createWorkerForm");
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    // Check if a server is selected
    if (!data.server_id) {
      showNotification("Please select a target server", "error");
      return;
    }

    showLoadingState("createWorkerBtn", "Creating...");

    // Use the remote worker creation endpoint with server selection
    fetch("/system-admin/api/workers/create-remote", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((result) => {
        if (result.success) {
          showNotification("Worker created successfully!", "success");
          bootstrap.Modal.getInstance(
            document.getElementById("createWorkerModal")
          ).hide();
          form.reset();
          setTimeout(() => loadWorkers(), 2000);
        } else {
          showNotification(
            result.message || "Failed to create worker",
            "error"
          );
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showNotification("Failed to create worker", "error");
      })
      .finally(() => {
        hideLoadingState(
          "createWorkerBtn",
          '<i class="fas fa-plus me-2"></i>Create Odoo Worker'
        );
      });
  }

  function workerAction(containerName, action) {
    showNotification(
      `${action.charAt(0).toUpperCase() + action.slice(1)}ing worker...`,
      "info",
      2000
    );

    fetch(`/system-admin/api/workers/${containerName}/action`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ action }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification(data.message, "success");
          setTimeout(() => loadWorkers(), 2000);
        } else {
          showNotification(data.message, "error");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showNotification("Worker action failed", "error");
      });
  }

  function rebalanceLoad() {
    showNotification("Rebalancing load...", "info");

    fetch("/system-admin/api/load-balancing/rebalance", { 
      method: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token() }}'
      }
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification(data.message, "success");
          loadWorkers();
        } else {
          showNotification(data.message, "error");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showNotification("Load rebalancing failed", "error");
      });
  }

  function refreshWorkers() {
    loadWorkers();
    updateLastCheckTime();
  }

  // Redis Management
  function loadRedisInfo() {
    fetch("/system-admin/api/redis/info")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          updateRedisInfo(data);
        } else {
          showRedisError();
        }
      })
      .catch((error) => {
        console.error("Failed to load Redis info:", error);
        showRedisError();
      });
  }

  function updateRedisInfo(data) {
    document.getElementById("redisInfo").innerHTML = `
        <div class="row">
            <div class="col-6">
                <div><strong>Version:</strong> ${
                  data.server_info?.version || "N/A"
                }</div>
                <div><strong>Uptime:</strong> ${
                  data.server_info?.uptime_days || 0
                } days</div>
            </div>
            <div class="col-6">
                <div><strong>Clients:</strong> ${
                  data.server_info?.connected_clients || 0
                }</div>
                <div><strong>Commands:</strong> ${
                  data.server_info?.total_commands_processed || 0
                }</div>
            </div>
        </div>
    `;

    const hitRate =
      data.server_info?.keyspace_hits && data.server_info?.keyspace_misses
        ? Math.round(
            (data.server_info.keyspace_hits /
              (data.server_info.keyspace_hits +
                data.server_info.keyspace_misses)) *
              100
          )
        : 0;

    document.getElementById("redisMemory").innerHTML = `
        <div class="row">
            <div class="col-6">
                <div><strong>Used:</strong> ${
                  data.memory_info?.used_memory_human || "N/A"
                }</div>
                <div><strong>Peak:</strong> ${
                  data.memory_info?.used_memory_peak_human || "N/A"
                }</div>
            </div>
            <div class="col-6">
                <div><strong>Hit Rate:</strong> ${hitRate}%</div>
                <div class="progress-modern mt-2">
                    <div class="progress-bar-modern bg-success" style="width: ${hitRate}%"></div>
                </div>
            </div>
        </div>
    `;
  }

  function showRedisError() {
    document.getElementById("redisInfo").innerHTML =
      '<div class="alert alert-danger">Failed to load Redis info</div>';
    document.getElementById("redisMemory").innerHTML =
      '<div class="alert alert-danger">Failed to load memory info</div>';
  }

  function searchRedisKeys() {
    const pattern = document.getElementById("redisKeyPattern").value || "*";

    fetch(`/system-admin/api/redis/keys?pattern=${encodeURIComponent(pattern)}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const keysHtml =
            data.keys
              ?.map(
                (key) =>
                  `${key.key} (${key.type}) ${
                    key.ttl ? `TTL: ${key.ttl}s` : ""
                  }`
              )
              .join("\n") || "No keys found matching pattern";

          document.getElementById("redisKeys").textContent = keysHtml;
        } else {
          document.getElementById("redisKeys").textContent =
            "Failed to search Redis keys";
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        document.getElementById("redisKeys").textContent =
          "Error searching Redis keys";
      });
  }

  function flushRedis() {
    if (
      confirm(
        "Are you sure you want to flush ALL Redis data? This cannot be undone!"
      )
    ) {
      fetch("/system-admin/api/redis/flush", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ database: "all" }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showNotification(data.message, "success");
            searchRedisKeys();
          } else {
            showNotification(data.message, "error");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showNotification("Failed to flush Redis", "error");
        });
    }
  }

  function refreshRedisInfo() {
    loadRedisInfo();
    updateLastCheckTime();
  }

  // PostgreSQL Management
  function loadPostgresInfo() {
    fetch("/system-admin/api/postgres/info")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          updatePostgresInfo(data);
        } else {
          showPostgresError();
        }
      })
      .catch((error) => {
        console.error("Failed to load PostgreSQL info:", error);
        showPostgresError();
      });
  }

  function updatePostgresInfo(data) {
    document.getElementById("postgresDatabases").innerHTML =
      data.databases
        ?.map(
          (db) =>
            `<div class="small"><strong>${db.name}</strong><br><span class="text-muted">${db.size}</span></div>`
        )
        .join("") || "No databases found";

    document.getElementById("postgresConnections").innerHTML =
      data.connections
        ?.map(
          (conn) =>
            `<div class="small"><strong>${conn.state}:</strong> ${conn.count}</div>`
        )
        .join("") || "No connection info";

    document.getElementById("postgresTables").innerHTML =
      data.tables
        ?.slice(0, 5)
        .map(
          (table) =>
            `<div class="small"><strong>${table.table}</strong><br><span class="text-muted">${table.size}</span></div>`
        )
        .join("") || "No tables found";
  }

  function showPostgresError() {
    ["postgresDatabases", "postgresConnections", "postgresTables"].forEach(
      (id) => {
        document.getElementById(id).innerHTML =
          '<div class="alert alert-danger small">Failed to load</div>';
      }
    );
  }

  function executePostgresQuery() {
    const query = document.getElementById("postgresQuery").value;
    if (!query.trim()) {
      showNotification("Please enter a query", "warning");
      return;
    }

    showLoadingState("executeQueryBtn", "Executing...");

    fetch("/system-admin/api/postgres/query", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ query }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          displayQueryResults(data);
        } else {
          document.getElementById(
            "postgresQueryResult"
          ).innerHTML = `<div class="alert alert-danger">Query failed: ${data.message}</div>`;
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        document.getElementById("postgresQueryResult").innerHTML =
          '<div class="alert alert-danger">Failed to execute query</div>';
      })
      .finally(() => {
        hideLoadingState(
          "executeQueryBtn",
          '<i class="fas fa-play me-2"></i>Execute Query'
        );
      });
  }

  function displayQueryResults(data) {
    let resultHtml = `<div class="alert alert-success">Query executed successfully. ${data.row_count} rows returned.</div>`;

    if (data.rows && data.rows.length > 0) {
      resultHtml +=
        '<div class="table-responsive"><table class="table table-sm table-striped">';
      resultHtml +=
        "<thead><tr>" +
        data.columns.map((col) => `<th>${col}</th>`).join("") +
        "</tr></thead>";
      resultHtml += "<tbody>";

      data.rows.slice(0, 50).forEach((row) => {
        resultHtml +=
          "<tr>" +
          data.columns.map((col) => `<td>${row[col] || ""}</td>`).join("") +
          "</tr>";
      });

      resultHtml += "</tbody></table></div>";

      if (data.rows.length > 50) {
        resultHtml +=
          '<div class="alert alert-info">Showing first 50 rows only</div>';
      }
    }

    document.getElementById("postgresQueryResult").innerHTML = resultHtml;
  }

  function refreshPostgresInfo() {
    loadPostgresInfo();
    updateLastCheckTime();
  }

  // Nginx Management
  function loadNginxStatus() {
    fetch("/system-admin/api/nginx/status")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          updateNginxStatus(data);
        } else {
          showNginxError();
        }
      })
      .catch((error) => {
        console.error("Failed to load Nginx status:", error);
        showNginxError();
      });
  }

  function updateNginxStatus(data) {
    document.getElementById("nginxStatus").innerHTML = `
        <div class="row">
            <div class="col-12">
                <div><strong>Status:</strong> <span class="badge bg-success">${
                  data.status || "Unknown"
                }</span></div>
                <div><strong>Container:</strong> ${
                  data.container_id || "N/A"
                }</div>
                <div><strong>Image:</strong> ${data.image || "N/A"}</div>
                <div><strong>CPU:</strong> ${data.cpu_percent || 0}%</div>
                <div><strong>Memory:</strong> ${Math.round(
                  (data.memory_usage || 0) / 1024 / 1024
                )} MB</div>
            </div>
        </div>
    `;

    document.getElementById("nginxLogs").textContent =
      data.logs?.join("\n") || "No recent logs";
  }

  function showNginxError() {
    document.getElementById("nginxStatus").innerHTML =
      '<div class="alert alert-danger">Failed to load Nginx status</div>';
    document.getElementById("nginxLogs").textContent = "Failed to load logs";
  }

  function reloadNginx() {
    showNotification("Reloading Nginx configuration...", "info");

    fetch("/system-admin/api/nginx/reload", { 
      method: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token() }}'
      }
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification(data.message, "success");
        } else {
          showNotification(data.message, "error");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showNotification("Failed to reload Nginx", "error");
      });
  }

  function refreshNginxStatus() {
    loadNginxStatus();
    updateLastCheckTime();
  }

  function viewNginxConfig() {
    showNotification("Opening Nginx configuration...", "info");
    // This would typically open a modal or new page with the config
  }

  // Monitoring
  function loadMonitoringData() {
    // Load resource monitoring
    fetch("/system-admin/api/system/resources")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          updateResourceMonitoring(data);
          updateContainerProcesses(data);
        }
      })
      .catch((error) => {
        console.error("Failed to load monitoring data:", error);
        showMonitoringError();
      });

    // Load load balancing status
    fetch("/system-admin/api/load-balancing/status")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          updateLoadBalancingStatus(data);
        }
      })
      .catch((error) => {
        console.error("Failed to load load balancing data:", error);
      });
  }

  function updateResourceMonitoring(data) {
    document.getElementById("resourceMonitoring").innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div><strong>CPU Cores:</strong> ${
                  data.cpu?.count || "N/A"
                }</div>
                <div><strong>Load Average:</strong> ${
                  data.cpu?.load_avg?.join(", ") || "N/A"
                }</div>
                <div><strong>Total Memory:</strong> ${
                  data.memory?.total_gb || "N/A"
                } GB</div>
                <div><strong>Available Memory:</strong> ${
                  data.memory?.available_gb || "N/A"
                } GB</div>
            </div>
            <div class="col-md-6">
                <div><strong>Total Disk:</strong> ${
                  data.disk?.total_gb || "N/A"
                } GB</div>
                <div><strong>Free Disk:</strong> ${
                  data.disk?.free_gb || "N/A"
                } GB</div>
                <div><strong>Network Sent:</strong> ${Math.round(
                  (data.network?.bytes_sent || 0) / 1024 / 1024
                )} MB</div>
                <div><strong>Network Received:</strong> ${Math.round(
                  (data.network?.bytes_recv || 0) / 1024 / 1024
                )} MB</div>
            </div>
        </div>
    `;
  }

  function updateContainerProcesses(data) {
    if (!data.top_containers || data.top_containers.length === 0) {
      document.getElementById("topProcesses").innerHTML =
        '<div class="text-muted">No container data available</div>';
      return;
    }

    let containersHtml = `
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Container</th>
                        <th>Status</th>
                        <th>CPU</th>
                        <th>Memory</th>
                        <th>Uptime</th>
                    </tr>
                </thead>
                <tbody>
    `;

    data.top_containers.forEach((container) => {
      const statusClass =
        container.status === "running" ? "success" : "secondary";
      containersHtml += `
            <tr>
                <td>${container.name}</td>
                <td><span class="badge bg-${statusClass}">${
        container.status
      }</span></td>
                <td>${container.cpu_percent}%</td>
                <td>${container.memory_mb} MB</td>
                <td>${container.uptime || "N/A"}</td>
            </tr>
        `;
    });

    containersHtml += "</tbody></table></div>";
    document.getElementById("topProcesses").innerHTML = containersHtml;
  }

  function updateLoadBalancingStatus(data) {
    let balanceHtml = `
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="metric-value">${data.overall_load || 0}%</div>
                <div class="metric-label">Overall Load</div>
            </div>
            <div class="col-md-3">
                <div class="metric-value">${data.total_tenants || 0}</div>
                <div class="metric-label">Total Tenants</div>
            </div>
            <div class="col-md-3">
                <div class="metric-value">${data.total_capacity || 0}</div>
                <div class="metric-label">Total Capacity</div>
            </div>
            <div class="col-md-3">
                <div class="metric-value">
                    <span class="badge bg-${
                      data.is_balanced ? "success" : "warning"
                    }">
                        ${data.is_balanced ? "Balanced" : "Unbalanced"}
                    </span>
                </div>
                <div class="metric-label">Status</div>
            </div>
        </div>
    `;

    if (data.workers && data.workers.length > 0) {
      balanceHtml += '<div class="row">';
      data.workers.forEach((worker) => {
        const statusClass = worker.is_healthy ? "success" : "danger";
        const loadClass =
          worker.load_percent > 80
            ? "danger"
            : worker.load_percent > 60
            ? "warning"
            : "success";

        balanceHtml += `
                <div class="col-md-6 mb-3">
                    <div class="border rounded p-3">
                        <h6>
                            <span class="status-indicator status-${
                              worker.is_healthy ? "healthy" : "critical"
                            } me-2"></span>
                            ${worker.worker_name}
                        </h6>
                        <div class="d-flex justify-content-between">
                            <span>Load: ${worker.current_tenants}/${
          worker.max_tenants
        }</span>
                            <span class="badge bg-${loadClass}">${
          worker.load_percent
        }%</span>
                        </div>
                        <div class="progress-modern mt-2">
                            <div class="progress-bar-modern bg-${loadClass}" style="width: ${
          worker.load_percent
        }%"></div>
                        </div>
                        <small class="text-muted">
                            Status: <span class="badge bg-${statusClass} badge-sm">${
          worker.status
        }</span>
                        </small>
                    </div>
                </div>
            `;
      });
      balanceHtml += "</div>";
    }

    document.getElementById("loadBalancingStatus").innerHTML = balanceHtml;
  }

  function showMonitoringError() {
    document.getElementById("resourceMonitoring").innerHTML =
      '<div class="alert alert-danger">Failed to load resource data</div>';
    document.getElementById("topProcesses").innerHTML =
      '<div class="alert alert-danger">Failed to load container data</div>';
    document.getElementById("loadBalancingStatus").innerHTML =
      '<div class="alert alert-danger">Failed to load load balancing data</div>';
  }

  function refreshMonitoringData() {
    loadMonitoringData();
    updateLastCheckTime();
  }

  function exportMetrics() {
    showNotification("Exporting metrics...", "info");

    // Simulate metrics export
    setTimeout(() => {
      const metricsData = {
        timestamp: new Date().toISOString(),
        system: {
          cpu: document.getElementById("systemCpuUsage").textContent,
          memory: document.getElementById("systemMemoryUsage").textContent,
          disk: document.getElementById("systemDiskUsage").textContent,
          workers: document.getElementById("activeWorkers").textContent,
        },
      };

      const blob = new Blob([JSON.stringify(metricsData, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `system-metrics-${
        new Date().toISOString().split("T")[0]
      }.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showNotification("Metrics exported successfully!", "success");
    }, 1500);
  }

  // Maintenance Mode
  function setupMaintenanceMode() {
    const checkbox = document.getElementById("confirmMaintenance");
    const button = document.getElementById("maintenanceBtn");

    checkbox.addEventListener("change", function () {
      button.disabled = !this.checked;
    });
  }

  function toggleMaintenanceMode() {
    showNotification("Toggling maintenance mode...", "info");

    // This would make an API call to toggle maintenance mode
    setTimeout(() => {
      showNotification("Maintenance mode updated!", "success");
      bootstrap.Modal.getInstance(
        document.getElementById("maintenanceModal")
      ).hide();
    }, 2000);
  }

  // Global Functions
  function refreshAllSystems() {
    showNotification("Refreshing all systems...", "info");

    loadSystemResources();
    loadWorkers();
    updateLastCheckTime();

    setTimeout(() => {
      showNotification("All systems refreshed!", "success");
    }, 2000);
  }

  function setupAutoRefresh() {
    // Refresh system resources every 30 seconds
    setInterval(() => {
      if (document.visibilityState === "visible") {
        loadSystemResources();
      }
    }, 30000);
  }

  // Worker settings helper
  function updateWorkerSettings() {
    const workerType = document.querySelector(
      'select[name="worker_type"]'
    ).value;
    const nameInput = document.querySelector('input[name="name"]');
    const maxTenantsSelect = document.querySelector(
      'select[name="max_tenants"]'
    );

    switch (workerType) {
      case "standard":
        nameInput.value = "odoo_worker_standard_";
        maxTenantsSelect.value = "10";
        break;
      case "high_performance":
        nameInput.value = "odoo_worker_hp_";
        maxTenantsSelect.value = "20";
        break;
      case "backup":
        nameInput.value = "odoo_worker_backup_";
        maxTenantsSelect.value = "5";
        break;
      case "development":
        nameInput.value = "odoo_worker_dev_";
        maxTenantsSelect.value = "5";
        break;
    }

    // Add timestamp for uniqueness
    nameInput.value += new Date().getTime().toString().slice(-6);
  }

  // Utility Functions
  function showLoadingState(buttonId, loadingText) {
    const button = document.getElementById(buttonId) || event.target;
    if (button) {
      button.disabled = true;
      button.setAttribute("data-original-html", button.innerHTML);
      button.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${loadingText}`;
    }
  }

  function hideLoadingState(buttonId, originalText) {
    const button = document.getElementById(buttonId) || event.target;
    if (button) {
      button.disabled = false;
      const originalHTML = button.getAttribute("data-original-html");
      button.innerHTML = originalHTML || originalText;
      button.removeAttribute("data-original-html");
    }
  }

  function showWorkerLogs(containerName) {
    fetch(`/system-admin/api/workers/${containerName}/logs`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const logsModal = `
                    <div class="modal fade" id="logsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-file-alt me-2"></i>
                                        Logs: ${containerName}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="log-container" style="max-height: 400px; overflow-y: auto;">
                                        ${data.logs.join("\n")}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="downloadLogs('${containerName}')">
                                        <i class="fas fa-download me-2"></i>Download
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

          // Remove existing modal
          const existingModal = document.getElementById("logsModal");
          if (existingModal) existingModal.remove();

          document.body.insertAdjacentHTML("beforeend", logsModal);
          const modal = new bootstrap.Modal(
            document.getElementById("logsModal")
          );
          modal.show();
        } else {
          showNotification("Failed to load worker logs", "error");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showNotification("Failed to load worker logs", "error");
      });
  }

  function downloadLogs(containerName) {
    showNotification("Downloading logs...", "info");

    fetch(`/system-admin/api/workers/${containerName}/logs`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const blob = new Blob([data.logs.join("\n")], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${containerName}-logs-${
            new Date().toISOString().split("T")[0]
          }.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showNotification("Logs downloaded successfully!", "success");
        } else {
          showNotification("Failed to download logs", "error");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showNotification("Failed to download logs", "error");
      });
  }

  // Initialize notification system if not already available
  if (typeof showNotification === "undefined") {
    window.showNotification = function (
      message,
      type = "info",
      duration = 5000
    ) {
      const alertClass = type === "error" ? "danger" : type;
      const iconClass =
        {
          success: "fa-check-circle",
          error: "fa-exclamation-circle",
          danger: "fa-exclamation-circle",
          warning: "fa-exclamation-triangle",
          info: "fa-info-circle",
        }[type] || "fa-info-circle";

      const alert = document.createElement("div");
      alert.className = `alert alert-${alertClass} alert-dismissible fade show position-fixed`;
      alert.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
        `;
      alert.innerHTML = `
            <i class="fas ${iconClass} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

      document.body.appendChild(alert);

      // Auto remove after duration
      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, duration);
    };
  }

  // ================= VPS SERVER MANAGEMENT FUNCTIONS =================

  let currentVPSServers = [];
  let selectedVPSServer = null;

  function refreshVPSServers() {
    showLoadingState(null, "Refreshing...");
    
    fetch('/system-admin/api/vps/servers/list')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          currentVPSServers = data.servers;
          updateVPSSummary(data);
          displayVPSServers(data.servers);
          showNotification("VPS servers refreshed successfully!", "success");
        } else {
          showNotification("Failed to load VPS servers: " + (data.message || "Unknown error"), "error");
        }
      })
      .catch(error => {
        console.error('Error loading VPS servers:', error);
        showNotification("Error loading VPS servers: " + error.message, "error");
      })
      .finally(() => {
        hideLoadingState();
      });
  }

  function updateVPSSummary(data) {
    document.getElementById('totalVPSServers').textContent = data.total_servers || 0;
    document.getElementById('onlineVPSServers').textContent = data.online_servers || 0;
    document.getElementById('workerCapableVPS').textContent = data.worker_capable_servers || 0;
    
    // Count servers with workers
    const serversWithWorkers = data.servers.filter(server => 
      server.current_services && server.current_services.some(service => 
        service.includes('odoo') || service.includes('worker')
      )
    ).length;
    document.getElementById('vpsWithWorkers').textContent = serversWithWorkers;
  }

  function displayVPSServers(servers) {
    const tbody = document.getElementById('vpsServersTableBody');
    
    if (!servers || servers.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="text-center py-4">
            <i class="fas fa-server fa-3x text-muted mb-3"></i>
            <p class="text-muted">No VPS servers found</p>
            <small class="text-muted">Servers from infra-admin will appear here</small>
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = servers.map(server => {
      const statusBadge = getStatusBadge(server.status, server.connection_status);
      const healthBadge = getHealthBadge(server.health_score);
      const specsBadge = `${server.cpu_cores || '?'}C/${server.memory_gb || '?'}GB/${server.disk_gb || '?'}GB`;
      const servicesBadge = (server.current_services || []).slice(0, 2).join(', ') + 
        (server.current_services && server.current_services.length > 2 ? '...' : '');
      
      // Count workers on this server (this would need to be fetched from backend)
      const workerCount = '?'; // TODO: Fetch actual worker count
      
      return `
        <tr onclick="selectVPSServer(${server.id})" style="cursor: pointer;">
          <td>
            <div class="d-flex align-items-center">
              <i class="fas fa-server me-2 text-primary"></i>
              <div>
                <div class="fw-bold">${server.name}</div>
                <small class="text-muted">${server.os_type || 'Unknown OS'}</small>
              </div>
            </div>
          </td>
          <td>
            <span class="badge bg-secondary">${server.ip_address}</span>
            ${server.internal_ip && server.internal_ip !== server.ip_address ? 
              `<br><small class="text-muted">Int: ${server.internal_ip}</small>` : ''}
          </td>
          <td>${statusBadge}</td>
          <td>${healthBadge}</td>
          <td>
            <span class="badge bg-info">${specsBadge}</span>
          </td>
          <td>
            <span class="badge bg-warning">${servicesBadge || 'None'}</span>
          </td>
          <td>
            <span class="badge bg-primary">${workerCount}</span>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); showVPSDetails(${server.id})" title="Details">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-outline-success btn-sm" onclick="event.stopPropagation(); testVPSConnection(${server.id})" title="Test Connection">
                <i class="fas fa-plug"></i>
              </button>
              <button class="btn btn-outline-info btn-sm" onclick="event.stopPropagation(); showVPSCommandModal(${server.id})" title="Execute Command">
                <i class="fas fa-terminal"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function getStatusBadge(status, connectionStatus) {
    if (connectionStatus === 'online') {
      return '<span class="badge bg-success"><i class="fas fa-circle me-1"></i>Online</span>';
    } else if (connectionStatus === 'offline') {
      return '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Offline</span>';
    } else if (status === 'active') {
      return '<span class="badge bg-primary"><i class="fas fa-check-circle me-1"></i>Active</span>';
    } else {
      return `<span class="badge bg-secondary"><i class="fas fa-question-circle me-1"></i>${status || 'Unknown'}</span>`;
    }
  }

  function getHealthBadge(healthScore) {
    if (healthScore >= 90) {
      return '<span class="badge bg-success">Excellent</span>';
    } else if (healthScore >= 70) {
      return '<span class="badge bg-warning">Good</span>';
    } else if (healthScore >= 50) {
      return '<span class="badge bg-orange">Fair</span>';
    } else {
      return '<span class="badge bg-danger">Poor</span>';
    }
  }

  function selectVPSServer(serverId) {
    selectedVPSServer = currentVPSServers.find(s => s.id === serverId);
    showVPSDetails(serverId);
  }

  function showVPSDetails(serverId) {
    const server = currentVPSServers.find(s => s.id === serverId);
    if (!server) {
      showNotification("Server not found", "error");
      return;
    }

    selectedVPSServer = server;
    
    const detailsHTML = `
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-primary">Server Information</h6>
          <table class="table table-sm">
            <tr><td><strong>Name:</strong></td><td>${server.name}</td></tr>
            <tr><td><strong>IP Address:</strong></td><td>${server.ip_address}</td></tr>
            <tr><td><strong>Status:</strong></td><td>${getStatusBadge(server.status, server.connection_status)}</td></tr>
            <tr><td><strong>Health Score:</strong></td><td>${getHealthBadge(server.health_score)}</td></tr>
            <tr><td><strong>OS Type:</strong></td><td>${server.os_type || 'Unknown'}</td></tr>
            <tr><td><strong>Network Zone:</strong></td><td>${server.network_zone || 'production'}</td></tr>
          </table>
        </div>
        <div class="col-md-6">
          <h6 class="text-info">System Specifications</h6>
          <table class="table table-sm">
            <tr><td><strong>CPU Cores:</strong></td><td>${server.cpu_cores || 'Unknown'}</td></tr>
            <tr><td><strong>Memory:</strong></td><td>${server.memory_gb || 'Unknown'} GB</td></tr>
            <tr><td><strong>Disk:</strong></td><td>${server.disk_gb || 'Unknown'} GB</td></tr>
            <tr><td><strong>Internal IP:</strong></td><td>${server.internal_ip || 'Not set'}</td></tr>
            <tr><td><strong>External IP:</strong></td><td>${server.external_ip || 'Not set'}</td></tr>
            <tr><td><strong>Last Check:</strong></td><td>${server.last_health_check ? new Date(server.last_health_check).toLocaleString() : 'Never'}</td></tr>
          </table>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-12">
          <h6 class="text-warning">Services & Roles</h6>
          <div class="mb-2">
            <strong>Service Roles:</strong>
            ${(server.service_roles || []).map(role => `<span class="badge bg-primary me-1">${role}</span>`).join('') || '<span class="text-muted">None defined</span>'}
          </div>
          <div>
            <strong>Current Services:</strong>
            ${(server.current_services || []).map(service => `<span class="badge bg-success me-1">${service}</span>`).join('') || '<span class="text-muted">None running</span>'}
          </div>
        </div>
      </div>
    `;

    document.getElementById('vpsServerDetails').innerHTML = detailsHTML;
    const modal = new bootstrap.Modal(document.getElementById('vpsServerModal'));
    modal.show();
  }

  function testVPSConnection(serverId = null) {
    const targetServerId = serverId || (selectedVPSServer ? selectedVPSServer.id : null);
    if (!targetServerId) {
      showNotification("No server selected", "error");
      return;
    }

    showLoadingState(null, "Testing connection...");

    fetch(`/system-admin/api/vps/servers/${targetServerId}/connect`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(`Connection successful to ${data.server_name}!`, "success");
        // Refresh the server list to show updated status
        setTimeout(() => refreshVPSServers(), 1000);
      } else {
        showNotification(`Connection failed to ${data.server_name}: ${data.message}`, "error");
      }
    })
    .catch(error => {
      console.error('Error testing connection:', error);
      showNotification("Error testing connection: " + error.message, "error");
    })
    .finally(() => {
      hideLoadingState();
    });
  }

  function showVPSWorkers(serverId = null) {
    const targetServerId = serverId || (selectedVPSServer ? selectedVPSServer.id : null);
    if (!targetServerId) {
      showNotification("No server selected", "error");
      return;
    }

    fetch(`/system-admin/api/vps/servers/${targetServerId}/workers`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show workers in a modal or new view
          displayVPSWorkers(data);
        } else {
          showNotification("Failed to load workers: " + data.message, "error");
        }
      })
      .catch(error => {
        console.error('Error loading workers:', error);
        showNotification("Error loading workers: " + error.message, "error");
      });
  }

  function displayVPSWorkers(data) {
    const workersHTML = `
      <div class="alert alert-info">
        <h6><i class="fas fa-server me-2"></i>${data.server_name} (${data.server_ip})</h6>
        <p class="mb-0">Workers: ${data.total_workers} | Running: ${data.running_workers} | Tenants: ${data.total_tenants}/${data.total_capacity}</p>
      </div>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Worker Name</th>
              <th>Status</th>
              <th>Port</th>
              <th>Load</th>
              <th>Last Seen</th>
            </tr>
          </thead>
          <tbody>
            ${data.workers.map(worker => `
              <tr>
                <td>${worker.name}</td>
                <td><span class="badge bg-${worker.status === 'running' ? 'success' : 'danger'}">${worker.status}</span></td>
                <td>${worker.port}</td>
                <td>
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar" role="progressbar" style="width: ${worker.load_percentage}%;">
                      ${worker.current_tenants}/${worker.max_tenants}
                    </div>
                  </div>
                </td>
                <td>${worker.last_seen ? new Date(worker.last_seen).toLocaleString() : 'Never'}</td>
              </tr>
            `).join('') || '<tr><td colspan="5" class="text-center text-muted">No workers found</td></tr>'}
          </tbody>
        </table>
      </div>
    `;

    document.getElementById('vpsServerDetails').innerHTML = workersHTML;
  }

  function showVPSCommandModal(serverId) {
    selectedVPSServer = currentVPSServers.find(s => s.id === serverId);
    if (!selectedVPSServer) {
      showNotification("Server not found", "error");
      return;
    }

    // Clear previous command and output
    document.getElementById('vpsCommand').value = '';
    document.getElementById('vpsCommandOutput').innerHTML = '<div class="text-muted">Command output will appear here...</div>';
    
    const modal = new bootstrap.Modal(document.getElementById('vpsCommandModal'));
    modal.show();
  }

  function executeVPSCommand() {
    const command = document.getElementById('vpsCommand').value.trim();
    if (!command) {
      showNotification("Please enter a command", "warning");
      return;
    }

    if (!selectedVPSServer) {
      showNotification("No server selected", "error");
      return;
    }

    const outputDiv = document.getElementById('vpsCommandOutput');
    outputDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin"></i> Executing command...</div>';

    fetch(`/system-admin/api/vps/servers/${selectedVPSServer.id}/execute`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ command: command })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const output = `
          <div class="mb-2">
            <strong class="text-success">$ ${data.command}</strong>
          </div>
          <div class="mb-2">
            <strong>Exit Code:</strong> <span class="badge bg-${data.exit_code === 0 ? 'success' : 'danger'}">${data.exit_code}</span>
          </div>
          ${data.output ? `
            <div class="mb-2">
              <strong>Output:</strong>
              <pre class="text-light mb-0">${data.output}</pre>
            </div>
          ` : ''}
          ${data.error ? `
            <div class="mb-2">
              <strong class="text-warning">Error:</strong>
              <pre class="text-warning mb-0">${data.error}</pre>
            </div>
          ` : ''}
        `;
        outputDiv.innerHTML = output;
        showNotification("Command executed successfully", "success");
      } else {
        outputDiv.innerHTML = `<div class="text-danger">Error: ${data.message}</div>`;
        showNotification("Command execution failed: " + data.message, "error");
      }
    })
    .catch(error => {
      console.error('Error executing command:', error);
      outputDiv.innerHTML = `<div class="text-danger">Network error: ${error.message}</div>`;
      showNotification("Error executing command: " + error.message, "error");
    });
  }

  function clearCommandOutput() {
    document.getElementById('vpsCommandOutput').innerHTML = '<div class="text-muted">Command output will appear here...</div>';
    document.getElementById('vpsCommand').value = '';
  }

  function healthCheckAllVPS() {
    showLoadingState(null, "Checking all servers...");

    fetch('/system-admin/api/vps/servers/health-check', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const summary = data.summary;
        showNotification(`Health check completed! Online: ${summary.online_servers}, Offline: ${summary.offline_servers}`, "info");
        refreshVPSServers(); // Refresh to show updated status
      } else {
        showNotification("Health check failed: " + data.message, "error");
      }
    })
    .catch(error => {
      console.error('Error during health check:', error);
      showNotification("Error during health check: " + error.message, "error");
    })
    .finally(() => {
      hideLoadingState();
    });
  }

  function filterVPSServers(filter) {
    let filteredServers;
    
    switch(filter) {
      case 'active':
        filteredServers = currentVPSServers.filter(s => s.status === 'active' || s.connection_status === 'online');
        break;
      case 'offline':
        filteredServers = currentVPSServers.filter(s => s.connection_status === 'offline' || s.status === 'offline');
        break;
      default:
        filteredServers = currentVPSServers;
    }
    
    displayVPSServers(filteredServers);
  }

  // Auto-load VPS servers when the tab is shown
  document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for when VPS tab is shown
    const vpsTab = document.querySelector('a[href="#vps-servers"]');
    if (vpsTab) {
      vpsTab.addEventListener('shown.bs.tab', function() {
        if (currentVPSServers.length === 0) {
          refreshVPSServers();
        }
      });
    }
  });

  // Debug function to check containers
  function debugContainers() {
    console.log("Debug containers called!");
    
    fetch('/system-admin/api/debug/containers')
      .then(response => response.json())
      .then(data => {
        console.log("Debug containers response:", data);
        
        if (data.success) {
          const debugInfo = `
            Total Containers: ${data.total_containers}
            Docker Available: ${data.docker_available}
            DB Workers: ${data.db_workers.length}
            
            Containers:
            ${data.containers.map(c => `- ${c.name} (${c.status}) - Odoo Worker: ${c.is_odoo_worker}`).join('\n')}
            
            DB Workers:
            ${data.db_workers.map(w => `- ${w.name} (${w.status})`).join('\n')}
          `;
          
          alert(debugInfo);
        } else {
          alert("Debug failed: " + data.message);
        }
      })
      .catch(error => {
        console.error("Debug error:", error);
        alert("Debug error: " + error.message);
      });
  }

  // Make sure key functions are available globally for onclick handlers
  window.createWorker = createWorker;
  window.debugContainers = debugContainers;
  window.refreshWorkers = refreshWorkers;
  window.loadWorkers = loadWorkers;
  window.rebalanceLoad = rebalanceLoad;
  window.refreshRedisInfo = refreshRedisInfo;
  window.flushRedis = flushRedis;
  window.searchRedisKeys = searchRedisKeys;
  window.refreshPostgresInfo = refreshPostgresInfo;
  window.executePostgresQuery = executePostgresQuery;
  window.reloadNginx = reloadNginx;
  window.refreshNginxStatus = refreshNginxStatus;
  window.viewNginxConfig = viewNginxConfig;
  window.refreshMonitoringData = refreshMonitoringData;
  window.refreshVPSServers = refreshVPSServers;
  window.healthCheckAllVPS = healthCheckAllVPS;
  window.testVPSConnection = testVPSConnection;
  window.showVPSDetails = showVPSDetails;
  window.showVPSCommandModal = showVPSCommandModal;
  window.executeVPSCommand = executeVPSCommand;
  window.clearCommandOutput = clearCommandOutput;
  window.filterVPSServers = filterVPSServers;
  window.showVPSWorkers = showVPSWorkers;
</script>
{% endblock %}
